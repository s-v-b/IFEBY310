<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Using with pyspark for data preprocessing – IFEBY310 - Spring 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b651517ce65839d647a86e2780455cfb.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a611943760b203044226a687a7214fb7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-563f26b41fe4db7f62e0e8fceb05db6b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-a611943760b203044226a687a7214fb7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="Using with pyspark for data preprocessing – IFEBY310 - Spring 2025">
<meta property="og:description" content="Homepage for course IFEBY310 - Big Data Technologies, Master MIDS Spring 2025.">
<meta property="og:image" content="https://s-v-b.github.io/IFEBY310/core/notebooks/notebook08_webdata-III_files/figure-html/cell-99-output-2.png">
<meta property="og:site_name" content="IFEBY310 - Spring 2025">
<meta property="og:image:height" content="875">
<meta property="og:image:width" content="2502">
</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Using with <code>pyspark</code> for data preprocessing</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../images/UniversiteParisCite_logo_horizontal_couleur_RVB.png" alt="" class="sidebar-logo light-content py-0 d-lg-inline d-none">
      <img src="../../images/UniversiteParisCite_logo_horizontal_couleur_RVB.png" alt="" class="sidebar-logo dark-content py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/s-v-b/IFEBY310" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Moodle" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Moodle"><i class="bi bi-person-fill"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://moodle.u-paris.fr/course/view.php?id=28534">
            Discussion forum
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://moodle.u-paris.fr/course/view.php?id=28534">
            Dépot
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://moodle.u-paris.fr/course/view.php?id=28534">
            Notes
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Information</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Glimpse</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../cours-syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../course-team.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Team</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Support</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../computing-access.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computing resources</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../computing-virtualenv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Virtual environments</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../computing-jupyter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Jupyter</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../quarto-format.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../computing-docker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Docker</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides-listings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks-listings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notebooks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects-listings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homeworks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../weeks-listings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Journal</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-description" id="toc-data-description" class="nav-link active" data-scroll-target="#data-description">Data description</a></li>
  <li><a href="#q1.-some-statistics-computations" id="toc-q1.-some-statistics-computations" class="nav-link" data-scroll-target="#q1.-some-statistics-computations">Q1. Some statistics / computations</a></li>
  <li><a href="#q2.-binary-classification" id="toc-q2.-binary-classification" class="nav-link" data-scroll-target="#q2.-binary-classification">Q2. Binary classification</a></li>
  <li><a href="#downloadread-the-data-and-have-a-look" id="toc-downloadread-the-data-and-have-a-look" class="nav-link" data-scroll-target="#downloadread-the-data-and-have-a-look">Download/read the data and have a look</a>
  <ul class="collapse">
  <li><a href="#round-up-the-usual-suspects" id="toc-round-up-the-usual-suspects" class="nav-link" data-scroll-target="#round-up-the-usual-suspects">Round up the usual suspects</a></li>
  <li><a href="#set-up-the-spark-client" id="toc-set-up-the-spark-client" class="nav-link" data-scroll-target="#set-up-the-spark-client">Set up the spark client</a>
  <ul class="collapse">
  <li><a href="#prepare-for-checkpointing" id="toc-prepare-for-checkpointing" class="nav-link" data-scroll-target="#prepare-for-checkpointing">Prepare for <code>checkpointing</code></a></li>
  <li><a href="#downloading-dataset-if-needed" id="toc-downloading-dataset-if-needed" class="nav-link" data-scroll-target="#downloading-dataset-if-needed">Downloading dataset (if needed)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#let-us-select-the-correct-users-and-build-a-training-dataset" id="toc-let-us-select-the-correct-users-and-build-a-training-dataset" class="nav-link" data-scroll-target="#let-us-select-the-correct-users-and-build-a-training-dataset">Let us select the correct users and build a training dataset</a>
  <ul class="collapse">
  <li><a href="#extraction" id="toc-extraction" class="nav-link" data-scroll-target="#extraction">Extraction</a></li>
  <li><a href="#transformation-of-the-data" id="toc-transformation-of-the-data" class="nav-link" data-scroll-target="#transformation-of-the-data">Transformation of the data</a></li>
  <li><a href="#load-step" id="toc-load-step" class="nav-link" data-scroll-target="#load-step">Load step</a></li>
  </ul></li>
  <li><a href="#preparation-of-the-training-dataset" id="toc-preparation-of-the-training-dataset" class="nav-link" data-scroll-target="#preparation-of-the-training-dataset">Preparation of the training dataset</a>
  <ul class="collapse">
  <li><a href="#finally" id="toc-finally" class="nav-link" data-scroll-target="#finally">Finally !!</a></li>
  </ul></li>
  <li><a href="#some-learning-forfrom-this-data" id="toc-some-learning-forfrom-this-data" class="nav-link" data-scroll-target="#some-learning-forfrom-this-data">Some learning for/from this data</a></li>
  <li><a href="#analyse-the-tables" id="toc-analyse-the-tables" class="nav-link" data-scroll-target="#analyse-the-tables">Analyse the tables</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/s-v-b/IFEBY310/edit/main/core/notebooks/notebook08_webdata-III.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/s-v-b/IFEBY310/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Using with <code>pyspark</code> for data preprocessing</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button" data-quarto-source-url="https://github.com/s-v-b/IFEBY310/blob/main/core/notebooks/notebook08_webdata-III.qmd">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>We want to use pyspark to preprocess a potentially huge dataset used for web-marketing.</p>
<section id="data-description" class="level2">
<h2 class="anchored" data-anchor-id="data-description">Data description</h2>
<p>The data is a <code>parquet</code> file which contains a dataframe with 8 columns:</p>
<ul>
<li><code>xid</code>: unique user id</li>
<li><code>action</code>: type of action. ‘C’ is a click, ‘O’ or ‘VSL’ is a web-display</li>
<li><code>date</code>: date of the action</li>
<li><code>website_id</code>: unique id of the website</li>
<li><code>url</code>: url of the webpage</li>
<li><code>category_id</code>: id of the display</li>
<li><code>zipcode</code>: postal zipcode of the user</li>
<li><code>device</code>: type of device used by the user</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Questions">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>According to you, how was that data asset collected?</li>
<li>In the likely context (digital marketing), what is a <em>web display</em>?</li>
<li>What are the different values of <code>category_id</code>? What are their respective frequencies?</li>
<li>What are the 10 most frequent websites (according to the data)?</li>
<li>What are the different devices used across the dataset?</li>
<li>When was the dataset collected?</li>
</ul>
</div>
</div>
</section>
<section id="q1.-some-statistics-computations" class="level2">
<h2 class="anchored" data-anchor-id="q1.-some-statistics-computations">Q1. Some statistics / computations</h2>
<p>Using <code>pyspark.sql</code>, we want to do the following things:</p>
<ol type="1">
<li>Compute the total number of unique users</li>
<li>Construct a column containing the total number of actions per user</li>
<li>Construct a column containing the number of days since the last action of the user</li>
<li>Construct a column containing the number of actions of each user for each modality of device</li>
</ol>
</section>
<section id="q2.-binary-classification" class="level2">
<h2 class="anchored" data-anchor-id="q2.-binary-classification">Q2. Binary classification</h2>
<p>Then, we want to construct a <em>classifier</em> to predict the click on category 1204 (<code>category_id</code>).</p>
<p>Here is an agenda for this:</p>
<ol type="1">
<li>Construction of a <em>feature matrix</em> where each line gathers information about a single user (identified by <code>xid</code>).</li>
<li>In the <em>feature matrix</em>, we need to keep only the rows (users) reporting exposition to the display in category 1204</li>
<li>Using this <em>training</em> dataset, <em>train</em> a <em>binary classifier</em>, and evaluate the classifier using a <em>precision/recall</em> curve computed on test data.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Viewing this dataset and the task at hand, we might be tempted to just filter rows satisfying condition <code>category_id=='1204'</code>, and fit a model that predict <code>action</code> given the other columns (or given some of them). This is not what the agenda suggests. Why?</p>
</div>
</div>
</section>
<section id="downloadread-the-data-and-have-a-look" class="level1">
<h1>Download/read the data and have a look</h1>
<section id="round-up-the-usual-suspects" class="level2">
<h2 class="anchored" data-anchor-id="round-up-the-usual-suspects">Round up the usual suspects</h2>
<div id="4db55f74" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests, zipfile, io</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> perf_counter</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># from pathlib import Path</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="3699fa0c" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYSPARK_PYTHON'</span>] <span class="op">=</span> sys.executable</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYSPARK_DRIVER_PYTHON'</span>] <span class="op">=</span> sys.executable</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="db02e3e5" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark <span class="im">import</span> SparkConf, SparkContext</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="332ab024" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> Window</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql.functions <span class="im">as</span> func</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> <span class="op">*</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col, lit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="3fdf9204" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.sparse <span class="im">import</span> csr_matrix</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The next imports are used at the end of the notebook.</p>
<div id="436987b6" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MaxAbsScaler</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> precision_recall_curve, f1_score</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="set-up-the-spark-client" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-spark-client">Set up the spark client</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>As we are not interacting with a preexisting cluster, we actually need to start a server and a client. So far, we used the <code>local</code> mode. Even with a laptop/desktop, several modes are available</p>
<ul>
<li><code>local</code></li>
<li><code>standalone</code></li>
<li></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Spark in standalone mode
</div>
</div>
<div class="callout-body-container callout-body">
<p>To launch spark in <code>standalone</code> mode, assuming the current working directory is <code>$SPARK_HOME</code></p>
<p>Assume that <code>hadoop</code> is running. This can be checked by monitoring java processes running on the local machine</p>
<pre class="jps"><code>$ jps 
30033 Jps
&gt;&gt;&gt; 18898 NodeManager
&gt;&gt;&gt; 17735 NameNode
&gt;&gt;&gt; 18216 SecondaryNameNode
&gt;&gt;&gt; 17965 DataNode
&gt;&gt;&gt; 18542 ResourceManager</code></pre>
<p><code>NameNode</code> <code>DataNode</code> and <code>SecondaryNameNode</code> have been launched by <code>start-dfs.sh</code>, while <code>NodeManager</code> and <code>ResourceManager</code> have been launched by <code>start-yarn</code>.</p>
<p>We can monitor <code>NameNode</code> at <code>http://localhost:9870</code></p>
<p>Then we may launch a <code>master</code> and a <code>worker</code> process.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./sbin/start-master.sh <span class="at">--ip</span> localhost</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> starting <span class="ex">org.apache.spark.deploy.master.Master,</span> logging to ...</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./sbin/start-worker.sh spark://localhost:7077</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We may now launch the instance of <code>SparkSession</code>, setting explicitly the <code>master</code> node and the port to communicate with the <code>master</code>.</p>
<div id="4afb4a5f" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># spark =  (</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     SparkSession.builder </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#             .appName("Spark webdata") </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#             .master("spark://localhost:7077") </span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#             .config("spark.driver.memory", "16G") </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#             .config("spark.driver.maxResultSize", "0") </span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#             .getOrCreate()</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>SparkUI should be reachable at <code>localhost:4040</code>.</p>
<p>The <code>master</code> can be monitored at <code>localhost:8080</code></p>
</div>
</div>
<div id="e5d15bda" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    SparkSession</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        .builder</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        .appName(<span class="st">"Taming Webdata"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        .config(<span class="st">"spark.driver.memory"</span>, <span class="st">"16G"</span>) </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        .config(<span class="st">"spark.driver.maxResultSize"</span>, <span class="st">"0"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        .getOrCreate()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>sc <span class="op">=</span> spark._sc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING: Using incubator modules: jdk.incubator.vector
Using Spark's default log4j profile: org/apache/spark/log4j2-defaults.properties
26/02/16 10:02:38 WARN Utils: Your hostname, boucheron-Precision-5480, resolves to a loopback address: 127.0.1.1; using 172.23.32.10 instead (on interface eth0)
26/02/16 10:02:38 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address
Using Spark's default log4j profile: org/apache/spark/log4j2-defaults.properties
Setting default log level to "WARN".
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
26/02/16 10:02:39 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</code></pre>
</div>
</div>
<section id="prepare-for-checkpointing" class="level3">
<h3 class="anchored" data-anchor-id="prepare-for-checkpointing">Prepare for <code>checkpointing</code></h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Handling this modest dataset will put our Spark server under strain. To make our life easier, we should prepare for caching and checkpointing.</p>
</div>
</div>
<div id="0dd66f3a" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    spark.sparkContext.setCheckpointDir(<span class="st">"file://"</span><span class="op">+</span> os.getcwd())</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="downloading-dataset-if-needed" class="level3">
<h3 class="anchored" data-anchor-id="downloading-dataset-if-needed">Downloading dataset (if needed)</h3>
<div id="4f18d260" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">'./data/webdata.parquet'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bb9611a8" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(path):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="st">"https://s-v-b.github.io/IFEBY310/data/webdata.parquet.zip"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> requests.get(url)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> zipfile.ZipFile(io.BytesIO(r.content))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    z.extractall(path<span class="op">=</span><span class="st">'./data/'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The default file system used by the spark object may be the local filesystem or hdfs. We explicitly ask for using the local filesystem.</p>
<div id="3243b2e0" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'file://'</span> <span class="op">+</span> os.path.abspath(path)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.read.parquet(file_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Have a look at <a href="http://localhost:4040/jobs/">Spark UI</a>. Did the preceding chunk trigger an action? If yes, how many stages? tasks?</p>
<p>Try</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tree <span class="op">-</span>L <span class="dv">1</span> data<span class="op">/</span>webdata.parquet<span class="op">/</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>to check wether the parquet file is partitioned. Check wether the different partitions are read concurrently.</p>
</div>
</div>
</section>
</section>
</section>
<section id="let-us-select-the-correct-users-and-build-a-training-dataset" class="level1">
<h1>Let us select the correct users and build a training dataset</h1>
<p>We construct a ETL (Extract Transform Load) process on this data using the <code>pyspark.sql</code> API.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>ETL (Extract Transform Load) and ELT (Extract Load Transform). Check that you understand these two acronyms. What do they stand for? What is the difference?</p>
</div>
</div>
<section id="extraction" class="level2">
<h2 class="anchored" data-anchor-id="extraction">Extraction</h2>
<p>Here <em>extraction</em> is just about reading the data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>What else coud <em>extraction</em> be about?</p>
</div>
</div>
<div id="89bc1f32" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df.show(n<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+------+-------------------+----------+--------------------+-----------+-------+------+
|                 xid|action|               date|website_id|                 url|category_id|zipcode|device|
+--------------------+------+-------------------+----------+--------------------+-----------+-------+------+
|001ff9b6-5383-422...|     O|2017-01-25 07:02:18|         3|http://www.8chanc...|     1002.0|  11370|   SMP|
|0056ab7a-3cba-4ed...|     O|2016-12-28 09:47:08|        54|http://www.salair...|     1002.0|  86000|   DSK|
|005ae4ab-363a-41a...|     O|2017-01-27 22:21:06|        74|http://www.realit...|     1002.0|  49700|   DSK|
+--------------------+------+-------------------+----------+--------------------+-----------+-------+------+
only showing top 3 rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>How many stages and tasks did action <code>show()</code> triggered?</p>
<p>Look at the plan details in tab SQL/Dataframe on <a href="http://localhost:4040/jobs/">Spark UI</a>. What are the different steps? Is there any shuffle?</p>
</div>
</div>
<p>Much of our work will consist in computing <code>window</code> functions over windows defined by a partition over <code>xid</code> (users). This comes from the fact that most of our features will be built by inspecting the events related with a given user (<code>xid</code>). Computing window functions over partitions is likely to trigger shuffles.</p>
<div id="e104acae" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.repartition(<span class="dv">20</span>, <span class="st">'xid'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Is repartition an action or a transformation?</p>
</div>
</div>
<div id="eaeb9f53" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df.cache()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string]</code></pre>
</div>
</div>
<div id="3606e624" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sc.setCheckpointDir("file://" + os.path.abspath(os.path.curdir))   </span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>df.checkpoint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 2:===============================================&gt;         (10 + 2) / 12][Stage 4:&gt;                                                        (0 + 20) / 20][Stage 4:============================&gt;                           (10 + 10) / 20]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>What does <code>checkpoint()</code> actually do?</li>
<li>Is it different from <code>df.cache()</code>?</li>
<li>How many jobs did <code>checkpoint()</code> trigger?</li>
<li>Did <code>checkpoint()</code> trigger writing in checkpoint directory?</li>
</ul>
</div>
</div>
<p>The dataframe <code>df</code> has been repartitioned in 20 partitions along column <code>xid</code>. Let us check that the number of distinct values of <code>xid</code> is balanced.</p>
<div id="18d40c61" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df.explain()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Evaluate the preceding chunk. How do the final and initial compare? Identify shuffle stages?</p>
</div>
</div>
<div id="6329dcba" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foo(x): <span class="cf">yield</span> <span class="bu">len</span>(<span class="bu">set</span>(x))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>n_xid_per_partitions <span class="op">=</span> ( </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    df.rdd</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(<span class="kw">lambda</span> x : x.xid)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    .mapPartitions(foo)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    .collect()</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 8:&gt;                                                        (0 + 20) / 20][Stage 8:==&gt;                                                      (1 + 19) / 20][Stage 8:=====&gt;                                                   (2 + 18) / 20][Stage 8:=============================================&gt;           (16 + 4) / 20]                                                                                </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>yield</code> is a Python keyword that indicates that <code>foo</code> is a function <em>generator</em>. Try <code>foo(range(10))</code> and then <code>next(foo(range(10)))</code> and finally</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>bar <span class="op">=</span> foo(<span class="bu">range</span>(<span class="dv">10</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(bar)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(bar)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>to guess what this means.</p>
<ul>
<li>Read the documentation of <code>mapPartitions()</code></li>
<li>Read chapter <code>Iterators, Generators, ...</code> in <a href="https://www.oreilly.com/library/view/fluent-python-2nd/9781492056348/">Fluent Python</a></li>
</ul>
</div>
</div>
<p>In the sequel, we may query dataframe <code>df</code> using <code>spark.sql()</code>. To make this possible, we have to register the dataframe as a temporary view.</p>
<div id="create-webdata-view" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"SHOW TABLES ;"</span>).show()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>df.createOrReplaceTempView(<span class="st">"webdata"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"SHOW TABLES ;"</span>).show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+---------+---------+-----------+
|namespace|tableName|isTemporary|
+---------+---------+-----------+
+---------+---------+-----------+

+---------+---------+-----------+
|namespace|tableName|isTemporary|
+---------+---------+-----------+
|         |  webdata|       true|
+---------+---------+-----------+
</code></pre>
</div>
</div>
<div id="a7435b53" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"DESC EXTENDED webdata ;"</span>).show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+-----------+---------+-------+
|   col_name|data_type|comment|
+-----------+---------+-------+
|        xid|   string|   NULL|
|     action|   string|   NULL|
|       date|timestamp|   NULL|
| website_id|   string|   NULL|
|        url|   string|   NULL|
|category_id|    float|   NULL|
|    zipcode|   string|   NULL|
|     device|   string|   NULL|
+-----------+---------+-------+
</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When handling managed tables (not views) and combined with <code>ANALYZE TABLE</code>, <code>DESC EXTENDED</code> can provide precious information on column statistics.</p>
</div>
</div>
</section>
<section id="transformation-of-the-data" class="level2">
<h2 class="anchored" data-anchor-id="transformation-of-the-data">Transformation of the data</h2>
<p>At this step we compute a lot of extra things from the data. The aim is to build <em>features</em> that describe users. The features will eventually be used by ML (Machine Learning) methods.</p>
<p>Each feature is built by feeding a <em>transformer</em> with a dataframe. Each transformer returns a dataframe with one more column.</p>
<p>The prospective list of transformers is:</p>
<pre><code>hour_transformer
weekday_transformer
n_actions_per_category_id_transformer
n_days_since_last_action_transformer
n_days_since_last_event_transformer
n_events_per_category_id_transformer
n_events_per_device_transformer
n_events_per_hour_transformer
n_events_per_website_id_transformer
n_events_per_weekday_transformer
n_unique_day_transformer
n_unique_device_transformer
n_unique_hour_transformer</code></pre>
<p>Each transformer (besides <code>hour_transformer</code> and <code>weekday_transformer</code>)is defined by</p>
<ul>
<li>a <code>Window</code> object (optional, some are used several times),</li>
<li>a column function that defines the added column, and</li>
<li>a name for the added column.</li>
</ul>
<p>The transformer is named after the name of the added column. All transformers have the same signature.</p>
<div id="dec2f439" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hour_transformer(df):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    hour <span class="op">=</span> func.hour(col(<span class="st">'date'</span>))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'hour'</span>, hour)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weekday_transformer(df):</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    weekday <span class="op">=</span> func.date_format(col(<span class="st">'date'</span>), <span class="st">'EEEE'</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'weekday'</span>, weekday)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="e579c0c0" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_transformer(df):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    n_events <span class="op">=</span> func.count(col(<span class="st">'action'</span>)).over(xid_partition)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events'</span>, n_events)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_action_transformer(df):</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    xid_action_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'action'</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    n_events_per_action <span class="op">=</span> func.count(col(<span class="st">'action'</span>)).over(xid_action_partition)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events_per_action'</span>, n_events_per_action)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_hour_transformer(df):</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    xid_hour_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'hour'</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    n_events_per_hour <span class="op">=</span> (</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        func.count(col(<span class="st">'action'</span>)).over(xid_hour_partition)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events_per_hour'</span>, n_events_per_hour)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_weekday_transformer(df):</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    xid_weekday_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'weekday'</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    n_events_per_weekday <span class="op">=</span> func.count(col(<span class="st">'action'</span>)).over(xid_weekday_partition)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events_per_weekday'</span>, n_events_per_weekday)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_days_since_last_event_transformer(df):</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    max_date <span class="op">=</span> func.<span class="bu">max</span>(col(<span class="st">'date'</span>)).over(xid_partition)</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    n_days_since_last_event <span class="op">=</span> func.datediff(func.current_date(), max_date)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_days_since_last_event'</span>,</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>                       n_days_since_last_event <span class="op">+</span> lit(<span class="fl">0.1</span>))</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_days_since_last_action_transformer(df):</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    xid_partition_action <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'action'</span>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    max_date <span class="op">=</span> func.<span class="bu">max</span>(col(<span class="st">'date'</span>)).over(xid_partition_action)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    n_days_since_last_action <span class="op">=</span> func.datediff(func.current_date(),</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>                                                        max_date)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_days_since_last_action'</span>,</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>                       n_days_since_last_action <span class="op">+</span> lit(<span class="fl">0.1</span>))</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_day_transformer(df):</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    dayofyear <span class="op">=</span> func.dayofyear(col(<span class="st">'date'</span>))</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    rank_day <span class="op">=</span> func.dense_rank().over(xid_partition.orderBy(dayofyear))</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>    n_unique_day <span class="op">=</span> func.last(rank_day).over(xid_partition)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_unique_day'</span>, n_unique_day)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_hour_transformer(df):</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>    xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>    rank_hour <span class="op">=</span> func.dense_rank().over(xid_partition.orderBy(<span class="st">'hour'</span>))</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    n_unique_hour <span class="op">=</span> func.last(rank_hour).over(xid_partition)</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_unique_hour'</span>, n_unique_hour)</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_device_transformer(df):</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>    xid_device_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'device'</span>)</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>    n_events_per_device <span class="op">=</span> func.count(func.col(<span class="st">'device'</span>)) <span class="op">\</span></span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        .over(xid_device_partition)</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events_per_device'</span>, n_events_per_device)</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_device_transformer(df):</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>    xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    rank_device <span class="op">=</span> func.dense_rank().over(xid_partition.orderBy(<span class="st">'device'</span>))</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>    n_unique_device <span class="op">=</span> func.last(rank_device).over(xid_partition)</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_device'</span>, n_unique_device)</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_actions_per_category_id_transformer(df):</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    xid_category_id_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'category_id'</span>,</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">'action'</span>)</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>    n_actions_per_category_id <span class="op">=</span> func.count(func.col(<span class="st">'action'</span>)) <span class="op">\</span></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>        .over(xid_category_id_partition)</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_actions_per_category_id'</span>, n_actions_per_category_id)</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_category_id_transformer(df):</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>    xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>    rank_category_id <span class="op">=</span> func.dense_rank().over(xid_partition<span class="op">\</span></span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>                                              .orderBy(<span class="st">'category_id'</span>))</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>    n_unique_category_id <span class="op">=</span> func.last(rank_category_id).over(xid_partition)</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_unique_category_id'</span>, n_unique_category_id)</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_category_id_transformer(df):</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    xid_category_id_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'category_id'</span>)</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>    n_events_per_category_id <span class="op">=</span> func.count(func.col(<span class="st">'action'</span>)) <span class="op">\</span></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>        .over(xid_category_id_partition)</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events_per_category_id'</span>, n_events_per_category_id)</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_website_id_transformer(df):</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>    xid_website_id_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>, <span class="st">'website_id'</span>)</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>    n_events_per_website_id <span class="op">=</span> func.count(col(<span class="st">'action'</span>))<span class="op">\</span></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>        .over(xid_website_id_partition)</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">'n_events_per_website_id'</span>, n_events_per_website_id)</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="f3268ed7" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>transformers <span class="op">=</span> [</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    hour_transformer,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    weekday_transformer,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    n_events_per_hour_transformer,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    n_events_per_weekday_transformer,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    n_days_since_last_event_transformer,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    n_days_since_last_action_transformer,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    n_unique_day_transformer,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    n_unique_hour_transformer,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    n_events_per_device_transformer,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    n_unique_device_transformer,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    n_actions_per_category_id_transformer,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    n_events_per_category_id_transformer,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    n_events_per_website_id_transformer,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>DRY compliance
</div>
</div>
<div class="callout-body-container callout-body">
<p>The code above looks repetitive. Its structure is not transparent.</p>
<p>The code does not emphasize the fact that transformers can not be applied in an arbitrary order (columns <code>hour</code> and <code>weekday</code> should be built before columns <code>n_events_per_hour</code>, <code>n_events_per_weekday</code>).</p>
<p>Is it possible to take advantage of the fact that the dataframe can be partitioned according to <code>xid</code> in advance?</p>
</div>
</div>
<p>As a warmup we first apply the two transformers that do not involve computing window functions.</p>
<div id="77d2b0f3" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> hour_transformer(df)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> weekday_transformer(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="28cbaaca" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df.cache()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string, hour: int, weekday: string]</code></pre>
</div>
</div>
<div id="7d474008" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df.checkpoint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string, hour: int, weekday: string]</code></pre>
</div>
</div>
<div id="6529486b" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df.explain()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Physical Plan ==
AdaptiveSparkPlan isFinalPlan=true
+- == Final Plan ==
   ResultQueryStage 1
   +- TableCacheQueryStage 0
      +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
            +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                  +- AdaptiveSparkPlan isFinalPlan=true
                  +- == Final Plan ==
                     ResultQueryStage 1
                     +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                        +- TableCacheQueryStage 0
                           +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                 +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                       +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                  +- == Initial Plan ==
                     Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                     +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                           +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                 +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
+- == Initial Plan ==
   InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
      +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
            +- AdaptiveSparkPlan isFinalPlan=true
            +- == Final Plan ==
               ResultQueryStage 1
               +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                  +- TableCacheQueryStage 0
                     +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                           +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                 +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
            +- == Initial Plan ==
               Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
               +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                     +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                           +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Did the two tranformations trigger jobs executions?</li>
<li>Did <code>cache()</code> trigger a job? (check on Spark UI)</li>
<li>Did <code>checkpoint()</code> trigger job(s)? If yes, could you spot shuffle stages?</li>
</ul>
</div>
</div>
<p>Next we run the transformers that only involve <code>partitionBy('xid')</code>.</p>
<div id="9e0ee9ec" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_transformer(df)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_days_since_last_event_transformer(df)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_unique_day_transformer(df)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_unique_hour_transformer(df)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_unique_device_transformer(df)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_unique_category_id_transformer(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Run <code>df.explain()</code>.</p>
<div class="callout callout-style-default callout-note callout-empty-content callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div id="e42384ed" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df.checkpoint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 14:&gt;                                                       (0 + 20) / 20]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string, hour: int, weekday: string, n_events: bigint, n_days_since_last_event: double, n_unique_day: int, n_unique_hour: int, n_device: int, n_unique_category_id: int]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How many jobs were triggered by <code>checkpoint()</code> ?</li>
<li>How many stages ? tasks ?</li>
<li>Could you spot shuffle reads and writes ?</li>
<li>Have a look at detailed plans on Spark UI.</li>
</ul>
</div>
</div>
<p>We run now the other transformers. These ones rely on refined partitions.</p>
<div id="e0c0d0d6" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_per_action_transformer(df)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>df.checkpoint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 16:&gt;                                                       (0 + 20) / 20][Stage 16:==&gt;                                                     (1 + 19) / 20][Stage 16:===================&gt;                                    (7 + 13) / 20][Stage 16:=====================================================&gt;  (19 + 1) / 20]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string, hour: int, weekday: string, n_events: bigint, n_days_since_last_event: double, n_unique_day: int, n_unique_hour: int, n_device: int, n_unique_category_id: int, n_events_per_action: bigint]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How many jobs were triggered by <code>checkpoint()</code> ?</li>
<li>How many stages ? tasks ?</li>
<li>Could you spot shuffle reads and writes ?</li>
<li>Have a look at detailed plans on Spark UI.</li>
</ul>
</div>
</div>
<div id="88966487" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_per_hour_transformer(df)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_per_weekday_transformer(df)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_days_since_last_event_transformer(df)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_days_since_last_action_transformer(df)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_per_device_transformer(df)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_actions_per_category_id_transformer(df)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_per_category_id_transformer(df)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> n_events_per_website_id_transformer(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="11f5f948" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df.checkpoint()</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>df.explain(mode<span class="op">=</span><span class="st">"codegen"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 18:&gt;                                                       (0 + 20) / 20]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 14 WholeStageCodegen subtrees.
== Subtree 1 / 14 (maxMethodCodeSize:154; maxConstantPoolSize:134(0.20% used); numInnerClasses:0) ==
*(1) Sort [xid#0 ASC NULLS FIRST], false, 0
+- TableCacheQueryStage 0
   +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
         +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
               +- AdaptiveSparkPlan isFinalPlan=true
                  +- == Final Plan ==
                     ResultQueryStage 1
                     +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                        +- TableCacheQueryStage 0
                           +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                 +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                       +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                  +- == Initial Plan ==
                     Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                     +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                           +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                 +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage1(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=1
/* 006 */ final class GeneratedIteratorForCodegenStage1 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */
/* 015 */   public GeneratedIteratorForCodegenStage1(Object[] references) {
/* 016 */     this.references = references;
/* 017 */   }
/* 018 */
/* 019 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 020 */     partitionIndex = index;
/* 021 */     this.inputs = inputs;
/* 022 */     sort_needToSort_0 = true;
/* 023 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 024 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 025 */
/* 026 */     inputadapter_input_0 = inputs[0];
/* 027 */
/* 028 */   }
/* 029 */
/* 030 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 031 */     while ( inputadapter_input_0.hasNext()) {
/* 032 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 033 */
/* 034 */       sort_sorter_0.insertRow((UnsafeRow)inputadapter_row_0);
/* 035 */       // shouldStop check is eliminated
/* 036 */     }
/* 037 */
/* 038 */   }
/* 039 */
/* 040 */   protected void processNext() throws java.io.IOException {
/* 041 */     if (sort_needToSort_0) {
/* 042 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 043 */       sort_addToSorter_0();
/* 044 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 045 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 046 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 047 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 048 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 049 */       sort_needToSort_0 = false;
/* 050 */     }
/* 051 */
/* 052 */     while ( sort_sortedIter_0.hasNext()) {
/* 053 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 054 */
/* 055 */       append(sort_outputRow_0);
/* 056 */
/* 057 */       if (shouldStop()) return;
/* 058 */     }
/* 059 */   }
/* 060 */
/* 061 */ }

== Subtree 2 / 14 (maxMethodCodeSize:746; maxConstantPoolSize:210(0.32% used); numInnerClasses:0) ==
*(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
+- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
   +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
      +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
         +- TableCacheQueryStage 0
            +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                  +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                        +- AdaptiveSparkPlan isFinalPlan=true
                           +- == Final Plan ==
                              ResultQueryStage 1
                              +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                 +- TableCacheQueryStage 0
                                    +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                          +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                           +- == Initial Plan ==
                              Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                              +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                    +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                          +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage2(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=2
/* 006 */ final class GeneratedIteratorForCodegenStage2 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage2(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(12, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 037 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 038 */       -1L : (inputadapter_row_0.getLong(2));
/* 039 */
/* 040 */       // common sub-expressions
/* 041 */
/* 042 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 043 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 044 */       null : (inputadapter_row_0.getUTF8String(0));
/* 045 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 046 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 047 */       null : (inputadapter_row_0.getUTF8String(1));
/* 048 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 049 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 050 */       null : (inputadapter_row_0.getUTF8String(3));
/* 051 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 052 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 053 */       null : (inputadapter_row_0.getUTF8String(4));
/* 054 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 055 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 056 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 057 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 058 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 059 */       null : (inputadapter_row_0.getUTF8String(6));
/* 060 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 061 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 062 */       null : (inputadapter_row_0.getUTF8String(7));
/* 063 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 064 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 065 */       -1 : (inputadapter_row_0.getInt(8));
/* 066 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 067 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 068 */       null : (inputadapter_row_0.getUTF8String(9));
/* 069 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 070 */       boolean project_isNull_12 = inputadapter_isNull_2;
/* 071 */       int project_value_12 = -1;
/* 072 */       if (!inputadapter_isNull_2) {
/* 073 */         project_value_12 = org.apache.spark.sql.catalyst.util.DateTimeUtils.microsToDays(inputadapter_value_2, ((java.time.ZoneId) references[1] /* zoneId */));
/* 074 */       }
/* 075 */       boolean project_isNull_11 = project_isNull_12;
/* 076 */       int project_value_11 = -1;
/* 077 */
/* 078 */       if (!project_isNull_12) {
/* 079 */         project_value_11 = org.apache.spark.sql.catalyst.util.DateTimeUtils.getDayInYear(project_value_12);
/* 080 */       }
/* 081 */       project_mutableStateArray_0[0].reset();
/* 082 */
/* 083 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 084 */
/* 085 */       if (inputadapter_isNull_0) {
/* 086 */         project_mutableStateArray_0[0].setNullAt(0);
/* 087 */       } else {
/* 088 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 089 */       }
/* 090 */
/* 091 */       if (inputadapter_isNull_1) {
/* 092 */         project_mutableStateArray_0[0].setNullAt(1);
/* 093 */       } else {
/* 094 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 095 */       }
/* 096 */
/* 097 */       if (inputadapter_isNull_2) {
/* 098 */         project_mutableStateArray_0[0].setNullAt(2);
/* 099 */       } else {
/* 100 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 101 */       }
/* 102 */
/* 103 */       if (inputadapter_isNull_3) {
/* 104 */         project_mutableStateArray_0[0].setNullAt(3);
/* 105 */       } else {
/* 106 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 107 */       }
/* 108 */
/* 109 */       if (inputadapter_isNull_4) {
/* 110 */         project_mutableStateArray_0[0].setNullAt(4);
/* 111 */       } else {
/* 112 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 113 */       }
/* 114 */
/* 115 */       if (inputadapter_isNull_5) {
/* 116 */         project_mutableStateArray_0[0].setNullAt(5);
/* 117 */       } else {
/* 118 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 119 */       }
/* 120 */
/* 121 */       if (inputadapter_isNull_6) {
/* 122 */         project_mutableStateArray_0[0].setNullAt(6);
/* 123 */       } else {
/* 124 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 125 */       }
/* 126 */
/* 127 */       if (inputadapter_isNull_7) {
/* 128 */         project_mutableStateArray_0[0].setNullAt(7);
/* 129 */       } else {
/* 130 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 131 */       }
/* 132 */
/* 133 */       if (inputadapter_isNull_8) {
/* 134 */         project_mutableStateArray_0[0].setNullAt(8);
/* 135 */       } else {
/* 136 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 137 */       }
/* 138 */
/* 139 */       if (inputadapter_isNull_9) {
/* 140 */         project_mutableStateArray_0[0].setNullAt(9);
/* 141 */       } else {
/* 142 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 143 */       }
/* 144 */
/* 145 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 146 */
/* 147 */       if (project_isNull_11) {
/* 148 */         project_mutableStateArray_0[0].setNullAt(11);
/* 149 */       } else {
/* 150 */         project_mutableStateArray_0[0].write(11, project_value_11);
/* 151 */       }
/* 152 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 153 */       // shouldStop check is eliminated
/* 154 */     }
/* 155 */
/* 156 */   }
/* 157 */
/* 158 */   protected void processNext() throws java.io.IOException {
/* 159 */     if (sort_needToSort_0) {
/* 160 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 161 */       sort_addToSorter_0();
/* 162 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 163 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[4] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 164 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 165 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 166 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 167 */       sort_needToSort_0 = false;
/* 168 */     }
/* 169 */
/* 170 */     while ( sort_sortedIter_0.hasNext()) {
/* 171 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 172 */
/* 173 */       append(sort_outputRow_0);
/* 174 */
/* 175 */       if (shouldStop()) return;
/* 176 */     }
/* 177 */   }
/* 178 */
/* 179 */ }

== Subtree 3 / 14 (maxMethodCodeSize:698; maxConstantPoolSize:132(0.20% used); numInnerClasses:0) ==
*(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
+- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
   +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
      +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
         +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
            +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
               +- TableCacheQueryStage 0
                  +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                        +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                              +- AdaptiveSparkPlan isFinalPlan=true
                                 +- == Final Plan ==
                                    ResultQueryStage 1
                                    +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                       +- TableCacheQueryStage 0
                                          +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                      +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                 +- == Initial Plan ==
                                    Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                    +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                          +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage3(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=3
/* 006 */ final class GeneratedIteratorForCodegenStage3 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private scala.collection.Iterator inputadapter_input_0;
/* 010 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 011 */
/* 012 */   public GeneratedIteratorForCodegenStage3(Object[] references) {
/* 013 */     this.references = references;
/* 014 */   }
/* 015 */
/* 016 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 017 */     partitionIndex = index;
/* 018 */     this.inputs = inputs;
/* 019 */     inputadapter_input_0 = inputs[0];
/* 020 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(12, 224);
/* 021 */
/* 022 */   }
/* 023 */
/* 024 */   protected void processNext() throws java.io.IOException {
/* 025 */     while ( inputadapter_input_0.hasNext()) {
/* 026 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 027 */
/* 028 */       // common sub-expressions
/* 029 */
/* 030 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 031 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 032 */       null : (inputadapter_row_0.getUTF8String(0));
/* 033 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 034 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 035 */       null : (inputadapter_row_0.getUTF8String(1));
/* 036 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 037 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 038 */       -1L : (inputadapter_row_0.getLong(2));
/* 039 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 040 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 041 */       null : (inputadapter_row_0.getUTF8String(3));
/* 042 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 043 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 044 */       null : (inputadapter_row_0.getUTF8String(4));
/* 045 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 046 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 047 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 048 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 049 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 050 */       null : (inputadapter_row_0.getUTF8String(6));
/* 051 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 052 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 053 */       null : (inputadapter_row_0.getUTF8String(7));
/* 054 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 055 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 056 */       -1 : (inputadapter_row_0.getInt(8));
/* 057 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 058 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 059 */       null : (inputadapter_row_0.getUTF8String(9));
/* 060 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 061 */       int inputadapter_value_12 = inputadapter_row_0.getInt(12);
/* 062 */       project_mutableStateArray_0[0].reset();
/* 063 */
/* 064 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 065 */
/* 066 */       if (inputadapter_isNull_0) {
/* 067 */         project_mutableStateArray_0[0].setNullAt(0);
/* 068 */       } else {
/* 069 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 070 */       }
/* 071 */
/* 072 */       if (inputadapter_isNull_1) {
/* 073 */         project_mutableStateArray_0[0].setNullAt(1);
/* 074 */       } else {
/* 075 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 076 */       }
/* 077 */
/* 078 */       if (inputadapter_isNull_2) {
/* 079 */         project_mutableStateArray_0[0].setNullAt(2);
/* 080 */       } else {
/* 081 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 082 */       }
/* 083 */
/* 084 */       if (inputadapter_isNull_3) {
/* 085 */         project_mutableStateArray_0[0].setNullAt(3);
/* 086 */       } else {
/* 087 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 088 */       }
/* 089 */
/* 090 */       if (inputadapter_isNull_4) {
/* 091 */         project_mutableStateArray_0[0].setNullAt(4);
/* 092 */       } else {
/* 093 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 094 */       }
/* 095 */
/* 096 */       if (inputadapter_isNull_5) {
/* 097 */         project_mutableStateArray_0[0].setNullAt(5);
/* 098 */       } else {
/* 099 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 100 */       }
/* 101 */
/* 102 */       if (inputadapter_isNull_6) {
/* 103 */         project_mutableStateArray_0[0].setNullAt(6);
/* 104 */       } else {
/* 105 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 106 */       }
/* 107 */
/* 108 */       if (inputadapter_isNull_7) {
/* 109 */         project_mutableStateArray_0[0].setNullAt(7);
/* 110 */       } else {
/* 111 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 112 */       }
/* 113 */
/* 114 */       if (inputadapter_isNull_8) {
/* 115 */         project_mutableStateArray_0[0].setNullAt(8);
/* 116 */       } else {
/* 117 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 118 */       }
/* 119 */
/* 120 */       if (inputadapter_isNull_9) {
/* 121 */         project_mutableStateArray_0[0].setNullAt(9);
/* 122 */       } else {
/* 123 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 124 */       }
/* 125 */
/* 126 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 127 */
/* 128 */       project_mutableStateArray_0[0].write(11, inputadapter_value_12);
/* 129 */       append((project_mutableStateArray_0[0].getRow()));
/* 130 */       if (shouldStop()) return;
/* 131 */     }
/* 132 */   }
/* 133 */
/* 134 */ }

== Subtree 4 / 14 (maxMethodCodeSize:731; maxConstantPoolSize:199(0.30% used); numInnerClasses:0) ==
*(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
+- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
   +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
      +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
         +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
            +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
               +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                  +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                     +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                        +- TableCacheQueryStage 0
                           +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                 +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                       +- AdaptiveSparkPlan isFinalPlan=true
                                          +- == Final Plan ==
                                             ResultQueryStage 1
                                             +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                +- TableCacheQueryStage 0
                                                   +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                         +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                               +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                          +- == Initial Plan ==
                                             Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                             +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                   +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                         +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage4(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=4
/* 006 */ final class GeneratedIteratorForCodegenStage4 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage4(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(12, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 070 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 071 */       -1 : (inputadapter_row_0.getInt(12));
/* 072 */       project_mutableStateArray_0[0].reset();
/* 073 */
/* 074 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 075 */
/* 076 */       if (inputadapter_isNull_0) {
/* 077 */         project_mutableStateArray_0[0].setNullAt(0);
/* 078 */       } else {
/* 079 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 080 */       }
/* 081 */
/* 082 */       if (inputadapter_isNull_1) {
/* 083 */         project_mutableStateArray_0[0].setNullAt(1);
/* 084 */       } else {
/* 085 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 086 */       }
/* 087 */
/* 088 */       if (inputadapter_isNull_2) {
/* 089 */         project_mutableStateArray_0[0].setNullAt(2);
/* 090 */       } else {
/* 091 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 092 */       }
/* 093 */
/* 094 */       if (inputadapter_isNull_3) {
/* 095 */         project_mutableStateArray_0[0].setNullAt(3);
/* 096 */       } else {
/* 097 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 098 */       }
/* 099 */
/* 100 */       if (inputadapter_isNull_4) {
/* 101 */         project_mutableStateArray_0[0].setNullAt(4);
/* 102 */       } else {
/* 103 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 104 */       }
/* 105 */
/* 106 */       if (inputadapter_isNull_5) {
/* 107 */         project_mutableStateArray_0[0].setNullAt(5);
/* 108 */       } else {
/* 109 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 110 */       }
/* 111 */
/* 112 */       if (inputadapter_isNull_6) {
/* 113 */         project_mutableStateArray_0[0].setNullAt(6);
/* 114 */       } else {
/* 115 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 116 */       }
/* 117 */
/* 118 */       if (inputadapter_isNull_7) {
/* 119 */         project_mutableStateArray_0[0].setNullAt(7);
/* 120 */       } else {
/* 121 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 122 */       }
/* 123 */
/* 124 */       if (inputadapter_isNull_8) {
/* 125 */         project_mutableStateArray_0[0].setNullAt(8);
/* 126 */       } else {
/* 127 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 128 */       }
/* 129 */
/* 130 */       if (inputadapter_isNull_9) {
/* 131 */         project_mutableStateArray_0[0].setNullAt(9);
/* 132 */       } else {
/* 133 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 134 */       }
/* 135 */
/* 136 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 137 */
/* 138 */       if (inputadapter_isNull_12) {
/* 139 */         project_mutableStateArray_0[0].setNullAt(11);
/* 140 */       } else {
/* 141 */         project_mutableStateArray_0[0].write(11, inputadapter_value_12);
/* 142 */       }
/* 143 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 144 */       // shouldStop check is eliminated
/* 145 */     }
/* 146 */
/* 147 */   }
/* 148 */
/* 149 */   protected void processNext() throws java.io.IOException {
/* 150 */     if (sort_needToSort_0) {
/* 151 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 152 */       sort_addToSorter_0();
/* 153 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 154 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 155 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 156 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 157 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 158 */       sort_needToSort_0 = false;
/* 159 */     }
/* 160 */
/* 161 */     while ( sort_sortedIter_0.hasNext()) {
/* 162 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 163 */
/* 164 */       append(sort_outputRow_0);
/* 165 */
/* 166 */       if (shouldStop()) return;
/* 167 */     }
/* 168 */   }
/* 169 */
/* 170 */ }

== Subtree 5 / 14 (maxMethodCodeSize:792; maxConstantPoolSize:199(0.30% used); numInnerClasses:0) ==
*(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
+- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
   +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
      +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
         +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
            +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
               +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                  +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                     +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                        +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                           +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                              +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                 +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                    +- TableCacheQueryStage 0
                                       +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                             +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                   +- AdaptiveSparkPlan isFinalPlan=true
                                                      +- == Final Plan ==
                                                         ResultQueryStage 1
                                                         +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                            +- TableCacheQueryStage 0
                                                               +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                     +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                           +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                      +- == Initial Plan ==
                                                         Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                         +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                               +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                     +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage5(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=5
/* 006 */ final class GeneratedIteratorForCodegenStage5 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage5(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(13, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       int inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1 : (inputadapter_row_0.getInt(11));
/* 072 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 073 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(13));
/* 075 */       project_mutableStateArray_0[0].reset();
/* 076 */
/* 077 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 078 */
/* 079 */       if (inputadapter_isNull_0) {
/* 080 */         project_mutableStateArray_0[0].setNullAt(0);
/* 081 */       } else {
/* 082 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 083 */       }
/* 084 */
/* 085 */       if (inputadapter_isNull_1) {
/* 086 */         project_mutableStateArray_0[0].setNullAt(1);
/* 087 */       } else {
/* 088 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 089 */       }
/* 090 */
/* 091 */       if (inputadapter_isNull_2) {
/* 092 */         project_mutableStateArray_0[0].setNullAt(2);
/* 093 */       } else {
/* 094 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 095 */       }
/* 096 */
/* 097 */       if (inputadapter_isNull_3) {
/* 098 */         project_mutableStateArray_0[0].setNullAt(3);
/* 099 */       } else {
/* 100 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 101 */       }
/* 102 */
/* 103 */       if (inputadapter_isNull_4) {
/* 104 */         project_mutableStateArray_0[0].setNullAt(4);
/* 105 */       } else {
/* 106 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 107 */       }
/* 108 */
/* 109 */       if (inputadapter_isNull_5) {
/* 110 */         project_mutableStateArray_0[0].setNullAt(5);
/* 111 */       } else {
/* 112 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 113 */       }
/* 114 */
/* 115 */       if (inputadapter_isNull_6) {
/* 116 */         project_mutableStateArray_0[0].setNullAt(6);
/* 117 */       } else {
/* 118 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 119 */       }
/* 120 */
/* 121 */       if (inputadapter_isNull_7) {
/* 122 */         project_mutableStateArray_0[0].setNullAt(7);
/* 123 */       } else {
/* 124 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 125 */       }
/* 126 */
/* 127 */       if (inputadapter_isNull_8) {
/* 128 */         project_mutableStateArray_0[0].setNullAt(8);
/* 129 */       } else {
/* 130 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 131 */       }
/* 132 */
/* 133 */       if (inputadapter_isNull_9) {
/* 134 */         project_mutableStateArray_0[0].setNullAt(9);
/* 135 */       } else {
/* 136 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 137 */       }
/* 138 */
/* 139 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 140 */
/* 141 */       if (inputadapter_isNull_11) {
/* 142 */         project_mutableStateArray_0[0].setNullAt(11);
/* 143 */       } else {
/* 144 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 145 */       }
/* 146 */
/* 147 */       if (inputadapter_isNull_13) {
/* 148 */         project_mutableStateArray_0[0].setNullAt(12);
/* 149 */       } else {
/* 150 */         project_mutableStateArray_0[0].write(12, inputadapter_value_13);
/* 151 */       }
/* 152 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 153 */       // shouldStop check is eliminated
/* 154 */     }
/* 155 */
/* 156 */   }
/* 157 */
/* 158 */   protected void processNext() throws java.io.IOException {
/* 159 */     if (sort_needToSort_0) {
/* 160 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 161 */       sort_addToSorter_0();
/* 162 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 163 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 164 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 165 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 166 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 167 */       sort_needToSort_0 = false;
/* 168 */     }
/* 169 */
/* 170 */     while ( sort_sortedIter_0.hasNext()) {
/* 171 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 172 */
/* 173 */       append(sort_outputRow_0);
/* 174 */
/* 175 */       if (shouldStop()) return;
/* 176 */     }
/* 177 */   }
/* 178 */
/* 179 */ }

== Subtree 6 / 14 (maxMethodCodeSize:853; maxConstantPoolSize:199(0.30% used); numInnerClasses:0) ==
*(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
+- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
   +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
      +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
         +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
            +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
               +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                  +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                     +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                        +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                           +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                              +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                 +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                    +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                       +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                          +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                             +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                +- TableCacheQueryStage 0
                                                   +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                         +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                               +- AdaptiveSparkPlan isFinalPlan=true
                                                                  +- == Final Plan ==
                                                                     ResultQueryStage 1
                                                                     +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                        +- TableCacheQueryStage 0
                                                                           +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                 +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                       +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                  +- == Initial Plan ==
                                                                     Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                     +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                           +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                 +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage6(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=6
/* 006 */ final class GeneratedIteratorForCodegenStage6 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage6(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(14, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       int inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1 : (inputadapter_row_0.getInt(11));
/* 072 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 073 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(12));
/* 075 */       boolean inputadapter_isNull_14 = inputadapter_row_0.isNullAt(14);
/* 076 */       int inputadapter_value_14 = inputadapter_isNull_14 ?
/* 077 */       -1 : (inputadapter_row_0.getInt(14));
/* 078 */       project_mutableStateArray_0[0].reset();
/* 079 */
/* 080 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 081 */
/* 082 */       if (inputadapter_isNull_0) {
/* 083 */         project_mutableStateArray_0[0].setNullAt(0);
/* 084 */       } else {
/* 085 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 086 */       }
/* 087 */
/* 088 */       if (inputadapter_isNull_1) {
/* 089 */         project_mutableStateArray_0[0].setNullAt(1);
/* 090 */       } else {
/* 091 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 092 */       }
/* 093 */
/* 094 */       if (inputadapter_isNull_2) {
/* 095 */         project_mutableStateArray_0[0].setNullAt(2);
/* 096 */       } else {
/* 097 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 098 */       }
/* 099 */
/* 100 */       if (inputadapter_isNull_3) {
/* 101 */         project_mutableStateArray_0[0].setNullAt(3);
/* 102 */       } else {
/* 103 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 104 */       }
/* 105 */
/* 106 */       if (inputadapter_isNull_4) {
/* 107 */         project_mutableStateArray_0[0].setNullAt(4);
/* 108 */       } else {
/* 109 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 110 */       }
/* 111 */
/* 112 */       if (inputadapter_isNull_5) {
/* 113 */         project_mutableStateArray_0[0].setNullAt(5);
/* 114 */       } else {
/* 115 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 116 */       }
/* 117 */
/* 118 */       if (inputadapter_isNull_6) {
/* 119 */         project_mutableStateArray_0[0].setNullAt(6);
/* 120 */       } else {
/* 121 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 122 */       }
/* 123 */
/* 124 */       if (inputadapter_isNull_7) {
/* 125 */         project_mutableStateArray_0[0].setNullAt(7);
/* 126 */       } else {
/* 127 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 128 */       }
/* 129 */
/* 130 */       if (inputadapter_isNull_8) {
/* 131 */         project_mutableStateArray_0[0].setNullAt(8);
/* 132 */       } else {
/* 133 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 134 */       }
/* 135 */
/* 136 */       if (inputadapter_isNull_9) {
/* 137 */         project_mutableStateArray_0[0].setNullAt(9);
/* 138 */       } else {
/* 139 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 140 */       }
/* 141 */
/* 142 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 143 */
/* 144 */       if (inputadapter_isNull_11) {
/* 145 */         project_mutableStateArray_0[0].setNullAt(11);
/* 146 */       } else {
/* 147 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 148 */       }
/* 149 */
/* 150 */       if (inputadapter_isNull_12) {
/* 151 */         project_mutableStateArray_0[0].setNullAt(12);
/* 152 */       } else {
/* 153 */         project_mutableStateArray_0[0].write(12, inputadapter_value_12);
/* 154 */       }
/* 155 */
/* 156 */       if (inputadapter_isNull_14) {
/* 157 */         project_mutableStateArray_0[0].setNullAt(13);
/* 158 */       } else {
/* 159 */         project_mutableStateArray_0[0].write(13, inputadapter_value_14);
/* 160 */       }
/* 161 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 162 */       // shouldStop check is eliminated
/* 163 */     }
/* 164 */
/* 165 */   }
/* 166 */
/* 167 */   protected void processNext() throws java.io.IOException {
/* 168 */     if (sort_needToSort_0) {
/* 169 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 170 */       sort_addToSorter_0();
/* 171 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 172 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 173 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 174 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 175 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 176 */       sort_needToSort_0 = false;
/* 177 */     }
/* 178 */
/* 179 */     while ( sort_sortedIter_0.hasNext()) {
/* 180 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 181 */
/* 182 */       append(sort_outputRow_0);
/* 183 */
/* 184 */       if (shouldStop()) return;
/* 185 */     }
/* 186 */   }
/* 187 */
/* 188 */ }

== Subtree 7 / 14 (maxMethodCodeSize:977; maxConstantPoolSize:199(0.30% used); numInnerClasses:0) ==
*(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
+- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
   +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
      +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
         +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
            +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
               +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                  +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                     +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                        +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                           +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                              +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                 +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                    +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                       +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                          +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                             +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                   +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                      +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                         +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                            +- TableCacheQueryStage 0
                                                               +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                     +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                           +- AdaptiveSparkPlan isFinalPlan=true
                                                                              +- == Final Plan ==
                                                                                 ResultQueryStage 1
                                                                                 +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                    +- TableCacheQueryStage 0
                                                                                       +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                             +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                   +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                              +- == Initial Plan ==
                                                                                 Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                 +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                       +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                             +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage7(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=7
/* 006 */ final class GeneratedIteratorForCodegenStage7 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage7(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(16, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       int inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1 : (inputadapter_row_0.getInt(11));
/* 072 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 073 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(12));
/* 075 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 076 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 077 */       -1 : (inputadapter_row_0.getInt(13));
/* 078 */       boolean inputadapter_isNull_15 = inputadapter_row_0.isNullAt(15);
/* 079 */       int inputadapter_value_15 = inputadapter_isNull_15 ?
/* 080 */       -1 : (inputadapter_row_0.getInt(15));
/* 081 */       boolean inputadapter_isNull_16 = inputadapter_row_0.isNullAt(16);
/* 082 */       long inputadapter_value_16 = inputadapter_isNull_16 ?
/* 083 */       -1L : (inputadapter_row_0.getLong(16));
/* 084 */       project_mutableStateArray_0[0].reset();
/* 085 */
/* 086 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 087 */
/* 088 */       if (inputadapter_isNull_0) {
/* 089 */         project_mutableStateArray_0[0].setNullAt(0);
/* 090 */       } else {
/* 091 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 092 */       }
/* 093 */
/* 094 */       if (inputadapter_isNull_1) {
/* 095 */         project_mutableStateArray_0[0].setNullAt(1);
/* 096 */       } else {
/* 097 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 098 */       }
/* 099 */
/* 100 */       if (inputadapter_isNull_2) {
/* 101 */         project_mutableStateArray_0[0].setNullAt(2);
/* 102 */       } else {
/* 103 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 104 */       }
/* 105 */
/* 106 */       if (inputadapter_isNull_3) {
/* 107 */         project_mutableStateArray_0[0].setNullAt(3);
/* 108 */       } else {
/* 109 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 110 */       }
/* 111 */
/* 112 */       if (inputadapter_isNull_4) {
/* 113 */         project_mutableStateArray_0[0].setNullAt(4);
/* 114 */       } else {
/* 115 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 116 */       }
/* 117 */
/* 118 */       if (inputadapter_isNull_5) {
/* 119 */         project_mutableStateArray_0[0].setNullAt(5);
/* 120 */       } else {
/* 121 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 122 */       }
/* 123 */
/* 124 */       if (inputadapter_isNull_6) {
/* 125 */         project_mutableStateArray_0[0].setNullAt(6);
/* 126 */       } else {
/* 127 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 128 */       }
/* 129 */
/* 130 */       if (inputadapter_isNull_7) {
/* 131 */         project_mutableStateArray_0[0].setNullAt(7);
/* 132 */       } else {
/* 133 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 134 */       }
/* 135 */
/* 136 */       if (inputadapter_isNull_8) {
/* 137 */         project_mutableStateArray_0[0].setNullAt(8);
/* 138 */       } else {
/* 139 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 140 */       }
/* 141 */
/* 142 */       if (inputadapter_isNull_9) {
/* 143 */         project_mutableStateArray_0[0].setNullAt(9);
/* 144 */       } else {
/* 145 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 146 */       }
/* 147 */
/* 148 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 149 */
/* 150 */       if (inputadapter_isNull_11) {
/* 151 */         project_mutableStateArray_0[0].setNullAt(11);
/* 152 */       } else {
/* 153 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 154 */       }
/* 155 */
/* 156 */       if (inputadapter_isNull_12) {
/* 157 */         project_mutableStateArray_0[0].setNullAt(12);
/* 158 */       } else {
/* 159 */         project_mutableStateArray_0[0].write(12, inputadapter_value_12);
/* 160 */       }
/* 161 */
/* 162 */       if (inputadapter_isNull_13) {
/* 163 */         project_mutableStateArray_0[0].setNullAt(13);
/* 164 */       } else {
/* 165 */         project_mutableStateArray_0[0].write(13, inputadapter_value_13);
/* 166 */       }
/* 167 */
/* 168 */       if (inputadapter_isNull_15) {
/* 169 */         project_mutableStateArray_0[0].setNullAt(14);
/* 170 */       } else {
/* 171 */         project_mutableStateArray_0[0].write(14, inputadapter_value_15);
/* 172 */       }
/* 173 */
/* 174 */       if (inputadapter_isNull_16) {
/* 175 */         project_mutableStateArray_0[0].setNullAt(15);
/* 176 */       } else {
/* 177 */         project_mutableStateArray_0[0].write(15, inputadapter_value_16);
/* 178 */       }
/* 179 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 180 */       // shouldStop check is eliminated
/* 181 */     }
/* 182 */
/* 183 */   }
/* 184 */
/* 185 */   protected void processNext() throws java.io.IOException {
/* 186 */     if (sort_needToSort_0) {
/* 187 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 188 */       sort_addToSorter_0();
/* 189 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 190 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 191 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 192 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 193 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 194 */       sort_needToSort_0 = false;
/* 195 */     }
/* 196 */
/* 197 */     while ( sort_sortedIter_0.hasNext()) {
/* 198 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 199 */
/* 200 */       append(sort_outputRow_0);
/* 201 */
/* 202 */       if (shouldStop()) return;
/* 203 */     }
/* 204 */   }
/* 205 */
/* 206 */ }

== Subtree 8 / 14 (maxMethodCodeSize:1000; maxConstantPoolSize:199(0.30% used); numInnerClasses:0) ==
*(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
+- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
   +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
      +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
         +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
            +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
               +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                  +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                     +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                        +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                           +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                              +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                 +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                    +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                       +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                          +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                             +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                   +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                      +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                         +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                            +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                               +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                  +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                     +- TableCacheQueryStage 0
                                                                        +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                              +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                    +- AdaptiveSparkPlan isFinalPlan=true
                                                                                       +- == Final Plan ==
                                                                                          ResultQueryStage 1
                                                                                          +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                             +- TableCacheQueryStage 0
                                                                                                +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                      +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                            +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                       +- == Initial Plan ==
                                                                                          Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                          +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                      +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage8(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=8
/* 006 */ final class GeneratedIteratorForCodegenStage8 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage8(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(17, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       int inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1 : (inputadapter_row_0.getInt(11));
/* 072 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 073 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(12));
/* 075 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 076 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 077 */       -1 : (inputadapter_row_0.getInt(13));
/* 078 */       boolean inputadapter_isNull_14 = inputadapter_row_0.isNullAt(14);
/* 079 */       int inputadapter_value_14 = inputadapter_isNull_14 ?
/* 080 */       -1 : (inputadapter_row_0.getInt(14));
/* 081 */       long inputadapter_value_16 = inputadapter_row_0.getLong(16);
/* 082 */       boolean inputadapter_isNull_15 = inputadapter_row_0.isNullAt(15);
/* 083 */       long inputadapter_value_15 = inputadapter_isNull_15 ?
/* 084 */       -1L : (inputadapter_row_0.getLong(15));
/* 085 */       project_mutableStateArray_0[0].reset();
/* 086 */
/* 087 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 088 */
/* 089 */       if (inputadapter_isNull_0) {
/* 090 */         project_mutableStateArray_0[0].setNullAt(0);
/* 091 */       } else {
/* 092 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 093 */       }
/* 094 */
/* 095 */       if (inputadapter_isNull_1) {
/* 096 */         project_mutableStateArray_0[0].setNullAt(1);
/* 097 */       } else {
/* 098 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 099 */       }
/* 100 */
/* 101 */       if (inputadapter_isNull_2) {
/* 102 */         project_mutableStateArray_0[0].setNullAt(2);
/* 103 */       } else {
/* 104 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 105 */       }
/* 106 */
/* 107 */       if (inputadapter_isNull_3) {
/* 108 */         project_mutableStateArray_0[0].setNullAt(3);
/* 109 */       } else {
/* 110 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 111 */       }
/* 112 */
/* 113 */       if (inputadapter_isNull_4) {
/* 114 */         project_mutableStateArray_0[0].setNullAt(4);
/* 115 */       } else {
/* 116 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 117 */       }
/* 118 */
/* 119 */       if (inputadapter_isNull_5) {
/* 120 */         project_mutableStateArray_0[0].setNullAt(5);
/* 121 */       } else {
/* 122 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 123 */       }
/* 124 */
/* 125 */       if (inputadapter_isNull_6) {
/* 126 */         project_mutableStateArray_0[0].setNullAt(6);
/* 127 */       } else {
/* 128 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 129 */       }
/* 130 */
/* 131 */       if (inputadapter_isNull_7) {
/* 132 */         project_mutableStateArray_0[0].setNullAt(7);
/* 133 */       } else {
/* 134 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 135 */       }
/* 136 */
/* 137 */       if (inputadapter_isNull_8) {
/* 138 */         project_mutableStateArray_0[0].setNullAt(8);
/* 139 */       } else {
/* 140 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 141 */       }
/* 142 */
/* 143 */       if (inputadapter_isNull_9) {
/* 144 */         project_mutableStateArray_0[0].setNullAt(9);
/* 145 */       } else {
/* 146 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 147 */       }
/* 148 */
/* 149 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 150 */
/* 151 */       if (inputadapter_isNull_11) {
/* 152 */         project_mutableStateArray_0[0].setNullAt(11);
/* 153 */       } else {
/* 154 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 155 */       }
/* 156 */
/* 157 */       if (inputadapter_isNull_12) {
/* 158 */         project_mutableStateArray_0[0].setNullAt(12);
/* 159 */       } else {
/* 160 */         project_mutableStateArray_0[0].write(12, inputadapter_value_12);
/* 161 */       }
/* 162 */
/* 163 */       if (inputadapter_isNull_13) {
/* 164 */         project_mutableStateArray_0[0].setNullAt(13);
/* 165 */       } else {
/* 166 */         project_mutableStateArray_0[0].write(13, inputadapter_value_13);
/* 167 */       }
/* 168 */
/* 169 */       if (inputadapter_isNull_14) {
/* 170 */         project_mutableStateArray_0[0].setNullAt(14);
/* 171 */       } else {
/* 172 */         project_mutableStateArray_0[0].write(14, inputadapter_value_14);
/* 173 */       }
/* 174 */
/* 175 */       project_mutableStateArray_0[0].write(15, inputadapter_value_16);
/* 176 */
/* 177 */       if (inputadapter_isNull_15) {
/* 178 */         project_mutableStateArray_0[0].setNullAt(16);
/* 179 */       } else {
/* 180 */         project_mutableStateArray_0[0].write(16, inputadapter_value_15);
/* 181 */       }
/* 182 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 183 */       // shouldStop check is eliminated
/* 184 */     }
/* 185 */
/* 186 */   }
/* 187 */
/* 188 */   protected void processNext() throws java.io.IOException {
/* 189 */     if (sort_needToSort_0) {
/* 190 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 191 */       sort_addToSorter_0();
/* 192 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 193 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 194 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 195 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 196 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 197 */       sort_needToSort_0 = false;
/* 198 */     }
/* 199 */
/* 200 */     while ( sort_sortedIter_0.hasNext()) {
/* 201 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 202 */
/* 203 */       append(sort_outputRow_0);
/* 204 */
/* 205 */       if (shouldStop()) return;
/* 206 */     }
/* 207 */   }
/* 208 */
/* 209 */ }

== Subtree 9 / 14 (maxMethodCodeSize:1023; maxConstantPoolSize:199(0.30% used); numInnerClasses:0) ==
*(9) Sort [xid#0 ASC NULLS FIRST, weekday#284 ASC NULLS FIRST], false, 0
+- *(9) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, _we0#1612]
   +- Window [count(action#1) windowspecdefinition(xid#0, hour#283, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_hour#1606L], [xid#0, hour#283]
      +- *(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
         +- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
            +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
               +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                  +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
                     +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
                        +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                           +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                              +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                                 +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                                    +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                                       +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                          +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                             +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                                +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                                   +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                      +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                         +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                            +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                               +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                                  +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                                     +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                                        +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                           +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                              +- TableCacheQueryStage 0
                                                                                 +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                                       +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                             +- AdaptiveSparkPlan isFinalPlan=true
                                                                                                +- == Final Plan ==
                                                                                                   ResultQueryStage 1
                                                                                                   +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                      +- TableCacheQueryStage 0
                                                                                                         +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                               +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                     +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                                +- == Initial Plan ==
                                                                                                   Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                   +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                         +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                               +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage9(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=9
/* 006 */ final class GeneratedIteratorForCodegenStage9 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage9(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(18, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       int inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1 : (inputadapter_row_0.getInt(11));
/* 072 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 073 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(12));
/* 075 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 076 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 077 */       -1 : (inputadapter_row_0.getInt(13));
/* 078 */       boolean inputadapter_isNull_14 = inputadapter_row_0.isNullAt(14);
/* 079 */       int inputadapter_value_14 = inputadapter_isNull_14 ?
/* 080 */       -1 : (inputadapter_row_0.getInt(14));
/* 081 */       long inputadapter_value_15 = inputadapter_row_0.getLong(15);
/* 082 */       long inputadapter_value_17 = inputadapter_row_0.getLong(17);
/* 083 */       boolean inputadapter_isNull_16 = inputadapter_row_0.isNullAt(16);
/* 084 */       long inputadapter_value_16 = inputadapter_isNull_16 ?
/* 085 */       -1L : (inputadapter_row_0.getLong(16));
/* 086 */       project_mutableStateArray_0[0].reset();
/* 087 */
/* 088 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 089 */
/* 090 */       if (inputadapter_isNull_0) {
/* 091 */         project_mutableStateArray_0[0].setNullAt(0);
/* 092 */       } else {
/* 093 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 094 */       }
/* 095 */
/* 096 */       if (inputadapter_isNull_1) {
/* 097 */         project_mutableStateArray_0[0].setNullAt(1);
/* 098 */       } else {
/* 099 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 100 */       }
/* 101 */
/* 102 */       if (inputadapter_isNull_2) {
/* 103 */         project_mutableStateArray_0[0].setNullAt(2);
/* 104 */       } else {
/* 105 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 106 */       }
/* 107 */
/* 108 */       if (inputadapter_isNull_3) {
/* 109 */         project_mutableStateArray_0[0].setNullAt(3);
/* 110 */       } else {
/* 111 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 112 */       }
/* 113 */
/* 114 */       if (inputadapter_isNull_4) {
/* 115 */         project_mutableStateArray_0[0].setNullAt(4);
/* 116 */       } else {
/* 117 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 118 */       }
/* 119 */
/* 120 */       if (inputadapter_isNull_5) {
/* 121 */         project_mutableStateArray_0[0].setNullAt(5);
/* 122 */       } else {
/* 123 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 124 */       }
/* 125 */
/* 126 */       if (inputadapter_isNull_6) {
/* 127 */         project_mutableStateArray_0[0].setNullAt(6);
/* 128 */       } else {
/* 129 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 130 */       }
/* 131 */
/* 132 */       if (inputadapter_isNull_7) {
/* 133 */         project_mutableStateArray_0[0].setNullAt(7);
/* 134 */       } else {
/* 135 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 136 */       }
/* 137 */
/* 138 */       if (inputadapter_isNull_8) {
/* 139 */         project_mutableStateArray_0[0].setNullAt(8);
/* 140 */       } else {
/* 141 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 142 */       }
/* 143 */
/* 144 */       if (inputadapter_isNull_9) {
/* 145 */         project_mutableStateArray_0[0].setNullAt(9);
/* 146 */       } else {
/* 147 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 148 */       }
/* 149 */
/* 150 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 151 */
/* 152 */       if (inputadapter_isNull_11) {
/* 153 */         project_mutableStateArray_0[0].setNullAt(11);
/* 154 */       } else {
/* 155 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 156 */       }
/* 157 */
/* 158 */       if (inputadapter_isNull_12) {
/* 159 */         project_mutableStateArray_0[0].setNullAt(12);
/* 160 */       } else {
/* 161 */         project_mutableStateArray_0[0].write(12, inputadapter_value_12);
/* 162 */       }
/* 163 */
/* 164 */       if (inputadapter_isNull_13) {
/* 165 */         project_mutableStateArray_0[0].setNullAt(13);
/* 166 */       } else {
/* 167 */         project_mutableStateArray_0[0].write(13, inputadapter_value_13);
/* 168 */       }
/* 169 */
/* 170 */       if (inputadapter_isNull_14) {
/* 171 */         project_mutableStateArray_0[0].setNullAt(14);
/* 172 */       } else {
/* 173 */         project_mutableStateArray_0[0].write(14, inputadapter_value_14);
/* 174 */       }
/* 175 */
/* 176 */       project_mutableStateArray_0[0].write(15, inputadapter_value_15);
/* 177 */
/* 178 */       project_mutableStateArray_0[0].write(16, inputadapter_value_17);
/* 179 */
/* 180 */       if (inputadapter_isNull_16) {
/* 181 */         project_mutableStateArray_0[0].setNullAt(17);
/* 182 */       } else {
/* 183 */         project_mutableStateArray_0[0].write(17, inputadapter_value_16);
/* 184 */       }
/* 185 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 186 */       // shouldStop check is eliminated
/* 187 */     }
/* 188 */
/* 189 */   }
/* 190 */
/* 191 */   protected void processNext() throws java.io.IOException {
/* 192 */     if (sort_needToSort_0) {
/* 193 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 194 */       sort_addToSorter_0();
/* 195 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 196 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 197 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 198 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 199 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 200 */       sort_needToSort_0 = false;
/* 201 */     }
/* 202 */
/* 203 */     while ( sort_sortedIter_0.hasNext()) {
/* 204 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 205 */
/* 206 */       append(sort_outputRow_0);
/* 207 */
/* 208 */       if (shouldStop()) return;
/* 209 */     }
/* 210 */   }
/* 211 */
/* 212 */ }

== Subtree 10 / 14 (maxMethodCodeSize:1139; maxConstantPoolSize:214(0.33% used); numInnerClasses:0) ==
*(10) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
+- *(10) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, (cast(datediff(2026-02-16, cast(_we0#1612 as date)) as double) + 0.1) AS n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L]
   +- Window [count(action#1) windowspecdefinition(xid#0, weekday#284, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_weekday#1608L], [xid#0, weekday#284]
      +- *(9) Sort [xid#0 ASC NULLS FIRST, weekday#284 ASC NULLS FIRST], false, 0
         +- *(9) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, _we0#1612]
            +- Window [count(action#1) windowspecdefinition(xid#0, hour#283, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_hour#1606L], [xid#0, hour#283]
               +- *(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                  +- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
                     +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
                        +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                           +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
                              +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
                                 +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                                    +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                                       +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                                          +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                                             +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                                                +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                                   +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                                      +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                                         +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                                            +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                               +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                                  +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                                     +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                                        +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                                           +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                                              +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                                                 +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                                    +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                                       +- TableCacheQueryStage 0
                                                                                          +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                                                +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                      +- AdaptiveSparkPlan isFinalPlan=true
                                                                                                         +- == Final Plan ==
                                                                                                            ResultQueryStage 1
                                                                                                            +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                               +- TableCacheQueryStage 0
                                                                                                                  +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                        +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                              +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                                         +- == Initial Plan ==
                                                                                                            Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                            +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                  +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                        +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage10(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=10
/* 006 */ final class GeneratedIteratorForCodegenStage10 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage10(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(19, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean project_isNull_11 = true;
/* 070 */       double project_value_11 = -1.0;
/* 071 */       boolean project_isNull_13 = true;
/* 072 */       int project_value_13 = -1;
/* 073 */
/* 074 */       boolean inputadapter_isNull_17 = inputadapter_row_0.isNullAt(17);
/* 075 */       long inputadapter_value_17 = inputadapter_isNull_17 ?
/* 076 */       -1L : (inputadapter_row_0.getLong(17));
/* 077 */       boolean project_isNull_15 = inputadapter_isNull_17;
/* 078 */       int project_value_15 = -1;
/* 079 */       if (!inputadapter_isNull_17) {
/* 080 */         project_value_15 = org.apache.spark.sql.catalyst.util.DateTimeUtils.microsToDays(inputadapter_value_17, ((java.time.ZoneId) references[1] /* zoneId */));
/* 081 */       }
/* 082 */       if (!project_isNull_15) {
/* 083 */         project_isNull_13 = false; // resultCode could change nullability.
/* 084 */         project_value_13 = 20500 - project_value_15;
/* 085 */
/* 086 */       }
/* 087 */       boolean project_isNull_12 = project_isNull_13;
/* 088 */       double project_value_12 = -1.0;
/* 089 */       if (!project_isNull_13) {
/* 090 */         project_value_12 = (double) project_value_13;
/* 091 */       }
/* 092 */       if (!project_isNull_12) {
/* 093 */         project_isNull_11 = false; // resultCode could change nullability.
/* 094 */
/* 095 */         project_value_11 = project_value_12 + 0.1D;
/* 096 */
/* 097 */       }
/* 098 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 099 */       int inputadapter_value_11 = inputadapter_isNull_11 ?
/* 100 */       -1 : (inputadapter_row_0.getInt(11));
/* 101 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 102 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 103 */       -1 : (inputadapter_row_0.getInt(12));
/* 104 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 105 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 106 */       -1 : (inputadapter_row_0.getInt(13));
/* 107 */       boolean inputadapter_isNull_14 = inputadapter_row_0.isNullAt(14);
/* 108 */       int inputadapter_value_14 = inputadapter_isNull_14 ?
/* 109 */       -1 : (inputadapter_row_0.getInt(14));
/* 110 */       long inputadapter_value_15 = inputadapter_row_0.getLong(15);
/* 111 */       long inputadapter_value_16 = inputadapter_row_0.getLong(16);
/* 112 */       long inputadapter_value_18 = inputadapter_row_0.getLong(18);
/* 113 */       project_mutableStateArray_0[0].reset();
/* 114 */
/* 115 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 116 */
/* 117 */       if (inputadapter_isNull_0) {
/* 118 */         project_mutableStateArray_0[0].setNullAt(0);
/* 119 */       } else {
/* 120 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 121 */       }
/* 122 */
/* 123 */       if (inputadapter_isNull_1) {
/* 124 */         project_mutableStateArray_0[0].setNullAt(1);
/* 125 */       } else {
/* 126 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 127 */       }
/* 128 */
/* 129 */       if (inputadapter_isNull_2) {
/* 130 */         project_mutableStateArray_0[0].setNullAt(2);
/* 131 */       } else {
/* 132 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 133 */       }
/* 134 */
/* 135 */       if (inputadapter_isNull_3) {
/* 136 */         project_mutableStateArray_0[0].setNullAt(3);
/* 137 */       } else {
/* 138 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 139 */       }
/* 140 */
/* 141 */       if (inputadapter_isNull_4) {
/* 142 */         project_mutableStateArray_0[0].setNullAt(4);
/* 143 */       } else {
/* 144 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 145 */       }
/* 146 */
/* 147 */       if (inputadapter_isNull_5) {
/* 148 */         project_mutableStateArray_0[0].setNullAt(5);
/* 149 */       } else {
/* 150 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 151 */       }
/* 152 */
/* 153 */       if (inputadapter_isNull_6) {
/* 154 */         project_mutableStateArray_0[0].setNullAt(6);
/* 155 */       } else {
/* 156 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 157 */       }
/* 158 */
/* 159 */       if (inputadapter_isNull_7) {
/* 160 */         project_mutableStateArray_0[0].setNullAt(7);
/* 161 */       } else {
/* 162 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 163 */       }
/* 164 */
/* 165 */       if (inputadapter_isNull_8) {
/* 166 */         project_mutableStateArray_0[0].setNullAt(8);
/* 167 */       } else {
/* 168 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 169 */       }
/* 170 */
/* 171 */       if (inputadapter_isNull_9) {
/* 172 */         project_mutableStateArray_0[0].setNullAt(9);
/* 173 */       } else {
/* 174 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 175 */       }
/* 176 */
/* 177 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 178 */
/* 179 */       if (project_isNull_11) {
/* 180 */         project_mutableStateArray_0[0].setNullAt(11);
/* 181 */       } else {
/* 182 */         project_mutableStateArray_0[0].write(11, project_value_11);
/* 183 */       }
/* 184 */
/* 185 */       if (inputadapter_isNull_11) {
/* 186 */         project_mutableStateArray_0[0].setNullAt(12);
/* 187 */       } else {
/* 188 */         project_mutableStateArray_0[0].write(12, inputadapter_value_11);
/* 189 */       }
/* 190 */
/* 191 */       if (inputadapter_isNull_12) {
/* 192 */         project_mutableStateArray_0[0].setNullAt(13);
/* 193 */       } else {
/* 194 */         project_mutableStateArray_0[0].write(13, inputadapter_value_12);
/* 195 */       }
/* 196 */
/* 197 */       if (inputadapter_isNull_13) {
/* 198 */         project_mutableStateArray_0[0].setNullAt(14);
/* 199 */       } else {
/* 200 */         project_mutableStateArray_0[0].write(14, inputadapter_value_13);
/* 201 */       }
/* 202 */
/* 203 */       if (inputadapter_isNull_14) {
/* 204 */         project_mutableStateArray_0[0].setNullAt(15);
/* 205 */       } else {
/* 206 */         project_mutableStateArray_0[0].write(15, inputadapter_value_14);
/* 207 */       }
/* 208 */
/* 209 */       project_mutableStateArray_0[0].write(16, inputadapter_value_15);
/* 210 */
/* 211 */       project_mutableStateArray_0[0].write(17, inputadapter_value_16);
/* 212 */
/* 213 */       project_mutableStateArray_0[0].write(18, inputadapter_value_18);
/* 214 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 215 */       // shouldStop check is eliminated
/* 216 */     }
/* 217 */
/* 218 */   }
/* 219 */
/* 220 */   protected void processNext() throws java.io.IOException {
/* 221 */     if (sort_needToSort_0) {
/* 222 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 223 */       sort_addToSorter_0();
/* 224 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 225 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[4] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 226 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 227 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 228 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 229 */       sort_needToSort_0 = false;
/* 230 */     }
/* 231 */
/* 232 */     while ( sort_sortedIter_0.hasNext()) {
/* 233 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 234 */
/* 235 */       append(sort_outputRow_0);
/* 236 */
/* 237 */       if (shouldStop()) return;
/* 238 */     }
/* 239 */   }
/* 240 */
/* 241 */ }

== Subtree 11 / 14 (maxMethodCodeSize:1202; maxConstantPoolSize:218(0.33% used); numInnerClasses:0) ==
*(11) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
+- *(11) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L, (cast(datediff(2026-02-16, cast(_we0#1615 as date)) as double) + 0.1) AS n_days_since_last_action#1613]
   +- Window [max(date#2) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1615], [xid#0, action#1]
      +- *(10) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
         +- *(10) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, (cast(datediff(2026-02-16, cast(_we0#1612 as date)) as double) + 0.1) AS n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L]
            +- Window [count(action#1) windowspecdefinition(xid#0, weekday#284, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_weekday#1608L], [xid#0, weekday#284]
               +- *(9) Sort [xid#0 ASC NULLS FIRST, weekday#284 ASC NULLS FIRST], false, 0
                  +- *(9) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, _we0#1612]
                     +- Window [count(action#1) windowspecdefinition(xid#0, hour#283, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_hour#1606L], [xid#0, hour#283]
                        +- *(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                           +- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
                              +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
                                 +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                                    +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
                                       +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
                                          +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                                             +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                                                +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                                                   +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                                                      +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                                                         +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                                            +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                                               +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                                                  +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                                                     +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                                        +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                                           +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                                              +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                                                 +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                                                    +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                                                       +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                                                          +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                                             +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                                                +- TableCacheQueryStage 0
                                                                                                   +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                                                         +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                               +- AdaptiveSparkPlan isFinalPlan=true
                                                                                                                  +- == Final Plan ==
                                                                                                                     ResultQueryStage 1
                                                                                                                     +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                        +- TableCacheQueryStage 0
                                                                                                                           +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                 +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                       +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                                                  +- == Initial Plan ==
                                                                                                                     Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                     +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                           +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                 +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage11(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=11
/* 006 */ final class GeneratedIteratorForCodegenStage11 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage11(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(20, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       double inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1.0 : (inputadapter_row_0.getDouble(11));
/* 072 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 073 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(12));
/* 075 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 076 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 077 */       -1 : (inputadapter_row_0.getInt(13));
/* 078 */       boolean inputadapter_isNull_14 = inputadapter_row_0.isNullAt(14);
/* 079 */       int inputadapter_value_14 = inputadapter_isNull_14 ?
/* 080 */       -1 : (inputadapter_row_0.getInt(14));
/* 081 */       boolean inputadapter_isNull_15 = inputadapter_row_0.isNullAt(15);
/* 082 */       int inputadapter_value_15 = inputadapter_isNull_15 ?
/* 083 */       -1 : (inputadapter_row_0.getInt(15));
/* 084 */       long inputadapter_value_16 = inputadapter_row_0.getLong(16);
/* 085 */       long inputadapter_value_17 = inputadapter_row_0.getLong(17);
/* 086 */       long inputadapter_value_18 = inputadapter_row_0.getLong(18);
/* 087 */       boolean project_isNull_19 = true;
/* 088 */       double project_value_19 = -1.0;
/* 089 */       boolean project_isNull_21 = true;
/* 090 */       int project_value_21 = -1;
/* 091 */
/* 092 */       boolean inputadapter_isNull_19 = inputadapter_row_0.isNullAt(19);
/* 093 */       long inputadapter_value_19 = inputadapter_isNull_19 ?
/* 094 */       -1L : (inputadapter_row_0.getLong(19));
/* 095 */       boolean project_isNull_23 = inputadapter_isNull_19;
/* 096 */       int project_value_23 = -1;
/* 097 */       if (!inputadapter_isNull_19) {
/* 098 */         project_value_23 = org.apache.spark.sql.catalyst.util.DateTimeUtils.microsToDays(inputadapter_value_19, ((java.time.ZoneId) references[1] /* zoneId */));
/* 099 */       }
/* 100 */       if (!project_isNull_23) {
/* 101 */         project_isNull_21 = false; // resultCode could change nullability.
/* 102 */         project_value_21 = 20500 - project_value_23;
/* 103 */
/* 104 */       }
/* 105 */       boolean project_isNull_20 = project_isNull_21;
/* 106 */       double project_value_20 = -1.0;
/* 107 */       if (!project_isNull_21) {
/* 108 */         project_value_20 = (double) project_value_21;
/* 109 */       }
/* 110 */       if (!project_isNull_20) {
/* 111 */         project_isNull_19 = false; // resultCode could change nullability.
/* 112 */
/* 113 */         project_value_19 = project_value_20 + 0.1D;
/* 114 */
/* 115 */       }
/* 116 */       project_mutableStateArray_0[0].reset();
/* 117 */
/* 118 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 119 */
/* 120 */       if (inputadapter_isNull_0) {
/* 121 */         project_mutableStateArray_0[0].setNullAt(0);
/* 122 */       } else {
/* 123 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 124 */       }
/* 125 */
/* 126 */       if (inputadapter_isNull_1) {
/* 127 */         project_mutableStateArray_0[0].setNullAt(1);
/* 128 */       } else {
/* 129 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 130 */       }
/* 131 */
/* 132 */       if (inputadapter_isNull_2) {
/* 133 */         project_mutableStateArray_0[0].setNullAt(2);
/* 134 */       } else {
/* 135 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 136 */       }
/* 137 */
/* 138 */       if (inputadapter_isNull_3) {
/* 139 */         project_mutableStateArray_0[0].setNullAt(3);
/* 140 */       } else {
/* 141 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 142 */       }
/* 143 */
/* 144 */       if (inputadapter_isNull_4) {
/* 145 */         project_mutableStateArray_0[0].setNullAt(4);
/* 146 */       } else {
/* 147 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 148 */       }
/* 149 */
/* 150 */       if (inputadapter_isNull_5) {
/* 151 */         project_mutableStateArray_0[0].setNullAt(5);
/* 152 */       } else {
/* 153 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 154 */       }
/* 155 */
/* 156 */       if (inputadapter_isNull_6) {
/* 157 */         project_mutableStateArray_0[0].setNullAt(6);
/* 158 */       } else {
/* 159 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 160 */       }
/* 161 */
/* 162 */       if (inputadapter_isNull_7) {
/* 163 */         project_mutableStateArray_0[0].setNullAt(7);
/* 164 */       } else {
/* 165 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 166 */       }
/* 167 */
/* 168 */       if (inputadapter_isNull_8) {
/* 169 */         project_mutableStateArray_0[0].setNullAt(8);
/* 170 */       } else {
/* 171 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 172 */       }
/* 173 */
/* 174 */       if (inputadapter_isNull_9) {
/* 175 */         project_mutableStateArray_0[0].setNullAt(9);
/* 176 */       } else {
/* 177 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 178 */       }
/* 179 */
/* 180 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 181 */
/* 182 */       if (inputadapter_isNull_11) {
/* 183 */         project_mutableStateArray_0[0].setNullAt(11);
/* 184 */       } else {
/* 185 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 186 */       }
/* 187 */
/* 188 */       if (inputadapter_isNull_12) {
/* 189 */         project_mutableStateArray_0[0].setNullAt(12);
/* 190 */       } else {
/* 191 */         project_mutableStateArray_0[0].write(12, inputadapter_value_12);
/* 192 */       }
/* 193 */
/* 194 */       if (inputadapter_isNull_13) {
/* 195 */         project_mutableStateArray_0[0].setNullAt(13);
/* 196 */       } else {
/* 197 */         project_mutableStateArray_0[0].write(13, inputadapter_value_13);
/* 198 */       }
/* 199 */
/* 200 */       if (inputadapter_isNull_14) {
/* 201 */         project_mutableStateArray_0[0].setNullAt(14);
/* 202 */       } else {
/* 203 */         project_mutableStateArray_0[0].write(14, inputadapter_value_14);
/* 204 */       }
/* 205 */
/* 206 */       if (inputadapter_isNull_15) {
/* 207 */         project_mutableStateArray_0[0].setNullAt(15);
/* 208 */       } else {
/* 209 */         project_mutableStateArray_0[0].write(15, inputadapter_value_15);
/* 210 */       }
/* 211 */
/* 212 */       project_mutableStateArray_0[0].write(16, inputadapter_value_16);
/* 213 */
/* 214 */       project_mutableStateArray_0[0].write(17, inputadapter_value_17);
/* 215 */
/* 216 */       project_mutableStateArray_0[0].write(18, inputadapter_value_18);
/* 217 */
/* 218 */       if (project_isNull_19) {
/* 219 */         project_mutableStateArray_0[0].setNullAt(19);
/* 220 */       } else {
/* 221 */         project_mutableStateArray_0[0].write(19, project_value_19);
/* 222 */       }
/* 223 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 224 */       // shouldStop check is eliminated
/* 225 */     }
/* 226 */
/* 227 */   }
/* 228 */
/* 229 */   protected void processNext() throws java.io.IOException {
/* 230 */     if (sort_needToSort_0) {
/* 231 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 232 */       sort_addToSorter_0();
/* 233 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 234 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[4] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 235 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 236 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 237 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 238 */       sort_needToSort_0 = false;
/* 239 */     }
/* 240 */
/* 241 */     while ( sort_sortedIter_0.hasNext()) {
/* 242 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 243 */
/* 244 */       append(sort_outputRow_0);
/* 245 */
/* 246 */       if (shouldStop()) return;
/* 247 */     }
/* 248 */   }
/* 249 */
/* 250 */ }

== Subtree 12 / 14 (maxMethodCodeSize:154; maxConstantPoolSize:134(0.20% used); numInnerClasses:0) ==
*(12) Sort [xid#0 ASC NULLS FIRST, knownfloatingpointnormalized(normalizenanandzero(category_id#5)) ASC NULLS FIRST], false, 0
+- Window [count(device#7) windowspecdefinition(xid#0, device#7, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_device#1616L], [xid#0, device#7]
   +- *(11) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
      +- *(11) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L, (cast(datediff(2026-02-16, cast(_we0#1615 as date)) as double) + 0.1) AS n_days_since_last_action#1613]
         +- Window [max(date#2) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1615], [xid#0, action#1]
            +- *(10) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
               +- *(10) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, (cast(datediff(2026-02-16, cast(_we0#1612 as date)) as double) + 0.1) AS n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L]
                  +- Window [count(action#1) windowspecdefinition(xid#0, weekday#284, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_weekday#1608L], [xid#0, weekday#284]
                     +- *(9) Sort [xid#0 ASC NULLS FIRST, weekday#284 ASC NULLS FIRST], false, 0
                        +- *(9) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, _we0#1612]
                           +- Window [count(action#1) windowspecdefinition(xid#0, hour#283, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_hour#1606L], [xid#0, hour#283]
                              +- *(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                 +- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
                                    +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
                                       +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                                          +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
                                             +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
                                                +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                                                   +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                                                      +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                                                         +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                                                            +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                                                               +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                                                  +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                                                     +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                                                        +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                                                           +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                                              +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                                                 +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                                                    +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                                                       +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                                                          +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                                                             +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                                                                +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                                                   +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                                                      +- TableCacheQueryStage 0
                                                                                                         +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                                                               +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                     +- AdaptiveSparkPlan isFinalPlan=true
                                                                                                                        +- == Final Plan ==
                                                                                                                           ResultQueryStage 1
                                                                                                                           +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                              +- TableCacheQueryStage 0
                                                                                                                                 +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                       +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                             +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                                                        +- == Initial Plan ==
                                                                                                                           Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                           +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                 +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                       +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage12(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=12
/* 006 */ final class GeneratedIteratorForCodegenStage12 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */
/* 015 */   public GeneratedIteratorForCodegenStage12(Object[] references) {
/* 016 */     this.references = references;
/* 017 */   }
/* 018 */
/* 019 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 020 */     partitionIndex = index;
/* 021 */     this.inputs = inputs;
/* 022 */     sort_needToSort_0 = true;
/* 023 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 024 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 025 */
/* 026 */     inputadapter_input_0 = inputs[0];
/* 027 */
/* 028 */   }
/* 029 */
/* 030 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 031 */     while ( inputadapter_input_0.hasNext()) {
/* 032 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 033 */
/* 034 */       sort_sorter_0.insertRow((UnsafeRow)inputadapter_row_0);
/* 035 */       // shouldStop check is eliminated
/* 036 */     }
/* 037 */
/* 038 */   }
/* 039 */
/* 040 */   protected void processNext() throws java.io.IOException {
/* 041 */     if (sort_needToSort_0) {
/* 042 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 043 */       sort_addToSorter_0();
/* 044 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 045 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 046 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 047 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 048 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 049 */       sort_needToSort_0 = false;
/* 050 */     }
/* 051 */
/* 052 */     while ( sort_sortedIter_0.hasNext()) {
/* 053 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 054 */
/* 055 */       append(sort_outputRow_0);
/* 056 */
/* 057 */       if (shouldStop()) return;
/* 058 */     }
/* 059 */   }
/* 060 */
/* 061 */ }

== Subtree 13 / 14 (maxMethodCodeSize:154; maxConstantPoolSize:134(0.20% used); numInnerClasses:0) ==
*(13) Sort [xid#0 ASC NULLS FIRST, knownfloatingpointnormalized(normalizenanandzero(category_id#5)) ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
+- Window [count(action#1) windowspecdefinition(xid#0, category_id#5, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_category_id#1620L], [xid#0, knownfloatingpointnormalized(normalizenanandzero(category_id#5))]
   +- *(12) Sort [xid#0 ASC NULLS FIRST, knownfloatingpointnormalized(normalizenanandzero(category_id#5)) ASC NULLS FIRST], false, 0
      +- Window [count(device#7) windowspecdefinition(xid#0, device#7, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_device#1616L], [xid#0, device#7]
         +- *(11) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
            +- *(11) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L, (cast(datediff(2026-02-16, cast(_we0#1615 as date)) as double) + 0.1) AS n_days_since_last_action#1613]
               +- Window [max(date#2) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1615], [xid#0, action#1]
                  +- *(10) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                     +- *(10) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, (cast(datediff(2026-02-16, cast(_we0#1612 as date)) as double) + 0.1) AS n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L]
                        +- Window [count(action#1) windowspecdefinition(xid#0, weekday#284, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_weekday#1608L], [xid#0, weekday#284]
                           +- *(9) Sort [xid#0 ASC NULLS FIRST, weekday#284 ASC NULLS FIRST], false, 0
                              +- *(9) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, _we0#1612]
                                 +- Window [count(action#1) windowspecdefinition(xid#0, hour#283, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_hour#1606L], [xid#0, hour#283]
                                    +- *(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                       +- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
                                          +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
                                             +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                                                +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
                                                   +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
                                                      +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                                                         +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                                                            +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                                                               +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                                                                  +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                                                                     +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                                                        +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                                                           +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                                                              +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                                                                 +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                                                    +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                                                       +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                                                          +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                                                             +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                                                                +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                                                                   +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                                                                      +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                                                         +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                                                            +- TableCacheQueryStage 0
                                                                                                               +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                                                                     +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                           +- AdaptiveSparkPlan isFinalPlan=true
                                                                                                                              +- == Final Plan ==
                                                                                                                                 ResultQueryStage 1
                                                                                                                                 +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                                    +- TableCacheQueryStage 0
                                                                                                                                       +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                             +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                                   +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                                                              +- == Initial Plan ==
                                                                                                                                 Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                                 +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                       +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                             +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage13(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=13
/* 006 */ final class GeneratedIteratorForCodegenStage13 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */
/* 015 */   public GeneratedIteratorForCodegenStage13(Object[] references) {
/* 016 */     this.references = references;
/* 017 */   }
/* 018 */
/* 019 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 020 */     partitionIndex = index;
/* 021 */     this.inputs = inputs;
/* 022 */     sort_needToSort_0 = true;
/* 023 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 024 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 025 */
/* 026 */     inputadapter_input_0 = inputs[0];
/* 027 */
/* 028 */   }
/* 029 */
/* 030 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 031 */     while ( inputadapter_input_0.hasNext()) {
/* 032 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 033 */
/* 034 */       sort_sorter_0.insertRow((UnsafeRow)inputadapter_row_0);
/* 035 */       // shouldStop check is eliminated
/* 036 */     }
/* 037 */
/* 038 */   }
/* 039 */
/* 040 */   protected void processNext() throws java.io.IOException {
/* 041 */     if (sort_needToSort_0) {
/* 042 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 043 */       sort_addToSorter_0();
/* 044 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 045 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 046 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 047 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 048 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 049 */       sort_needToSort_0 = false;
/* 050 */     }
/* 051 */
/* 052 */     while ( sort_sortedIter_0.hasNext()) {
/* 053 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 054 */
/* 055 */       append(sort_outputRow_0);
/* 056 */
/* 057 */       if (shouldStop()) return;
/* 058 */     }
/* 059 */   }
/* 060 */
/* 061 */ }

== Subtree 14 / 14 (maxMethodCodeSize:1178; maxConstantPoolSize:208(0.32% used); numInnerClasses:0) ==
*(14) Sort [xid#0 ASC NULLS FIRST, website_id#3 ASC NULLS FIRST], false, 0
+- *(14) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L, n_days_since_last_action#1613, n_events_per_device#1616L, n_actions_per_category_id#1618L, n_events_per_category_id#1620L]
   +- Window [count(action#1) windowspecdefinition(xid#0, category_id#5, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_actions_per_category_id#1618L], [xid#0, knownfloatingpointnormalized(normalizenanandzero(category_id#5)), action#1]
      +- *(13) Sort [xid#0 ASC NULLS FIRST, knownfloatingpointnormalized(normalizenanandzero(category_id#5)) ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
         +- Window [count(action#1) windowspecdefinition(xid#0, category_id#5, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_category_id#1620L], [xid#0, knownfloatingpointnormalized(normalizenanandzero(category_id#5))]
            +- *(12) Sort [xid#0 ASC NULLS FIRST, knownfloatingpointnormalized(normalizenanandzero(category_id#5)) ASC NULLS FIRST], false, 0
               +- Window [count(device#7) windowspecdefinition(xid#0, device#7, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_device#1616L], [xid#0, device#7]
                  +- *(11) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                     +- *(11) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L, (cast(datediff(2026-02-16, cast(_we0#1615 as date)) as double) + 0.1) AS n_days_since_last_action#1613]
                        +- Window [max(date#2) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1615], [xid#0, action#1]
                           +- *(10) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                              +- *(10) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, (cast(datediff(2026-02-16, cast(_we0#1612 as date)) as double) + 0.1) AS n_days_since_last_event#1610, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, n_events_per_weekday#1608L]
                                 +- Window [count(action#1) windowspecdefinition(xid#0, weekday#284, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_weekday#1608L], [xid#0, weekday#284]
                                    +- *(9) Sort [xid#0 ASC NULLS FIRST, weekday#284 ASC NULLS FIRST], false, 0
                                       +- *(9) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, n_events_per_hour#1606L, _we0#1612]
                                          +- Window [count(action#1) windowspecdefinition(xid#0, hour#283, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_hour#1606L], [xid#0, hour#283]
                                             +- *(8) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                +- *(8) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, n_events_per_action#1172L, _we0#1612]
                                                   +- Window [count(action#1) windowspecdefinition(xid#0, action#1, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events_per_action#1172L], [xid#0, action#1]
                                                      +- *(7) Sort [xid#0 ASC NULLS FIRST, action#1 ASC NULLS FIRST], false, 0
                                                         +- *(7) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732, n_unique_category_id#746, _we0#1612]
                                                            +- Window [last(_w0#756, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_category_id#746, max(date#2) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#1612], [xid#0]
                                                               +- Window [dense_rank(category_id#5) windowspecdefinition(xid#0, category_id#5 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#756], [xid#0], [category_id#5 ASC NULLS FIRST]
                                                                  +- *(6) Sort [xid#0 ASC NULLS FIRST, category_id#5 ASC NULLS FIRST], false, 0
                                                                     +- *(6) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718, n_device#732]
                                                                        +- Window [last(_w0#742, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_device#732], [xid#0]
                                                                           +- Window [dense_rank(device#7) windowspecdefinition(xid#0, device#7 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#742], [xid#0], [device#7 ASC NULLS FIRST]
                                                                              +- *(5) Sort [xid#0 ASC NULLS FIRST, device#7 ASC NULLS FIRST], false, 0
                                                                                 +- *(5) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700, n_unique_hour#718]
                                                                                    +- Window [last(_w0#728, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_hour#718], [xid#0]
                                                                                       +- Window [dense_rank(hour#283) windowspecdefinition(xid#0, hour#283 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#728], [xid#0], [hour#283 ASC NULLS FIRST]
                                                                                          +- *(4) Sort [xid#0 ASC NULLS FIRST, hour#283 ASC NULLS FIRST], false, 0
                                                                                             +- *(4) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, n_unique_day#700]
                                                                                                +- Window [last(_w0#710, false) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_unique_day#700], [xid#0]
                                                                                                   +- *(3) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, _w0#710]
                                                                                                      +- Window [dense_rank(_w0#711) windowspecdefinition(xid#0, _w0#711 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS _w0#710], [xid#0], [_w0#711 ASC NULLS FIRST]
                                                                                                         +- *(2) Sort [xid#0 ASC NULLS FIRST, _w0#711 ASC NULLS FIRST], false, 0
                                                                                                            +- *(2) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284, n_events#695L, dayofyear(cast(date#2 as date)) AS _w0#711]
                                                                                                               +- Window [count(action#1) windowspecdefinition(xid#0, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS n_events#695L], [xid#0]
                                                                                                                  +- *(1) Sort [xid#0 ASC NULLS FIRST], false, 0
                                                                                                                     +- TableCacheQueryStage 0
                                                                                                                        +- InMemoryTableScan [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284]
                                                                                                                              +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour#283, weekday#284], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                    +- AdaptiveSparkPlan isFinalPlan=true
                                                                                                                                       +- == Final Plan ==
                                                                                                                                          ResultQueryStage 1
                                                                                                                                          +- *(1) Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                                             +- TableCacheQueryStage 0
                                                                                                                                                +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                                      +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                                            +- AdaptiveSparkPlan isFinalPlan=true
                     +- == Final Plan ==
                        ResultQueryStage 1
                        +- ShuffleQueryStage 0
                           +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                              +- *(1) ColumnarToRow
                                 +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                     +- == Initial Plan ==
                        Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                        +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
                                                                                                                                       +- == Initial Plan ==
                                                                                                                                          Project [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7, hour(date#2, Some(Europe/Paris)) AS hour#283, date_format(date#2, EEEE, Some(Europe/Paris)) AS weekday#284]
                                                                                                                                          +- InMemoryTableScan [action#1, category_id#5, date#2, device#7, url#4, website_id#3, xid#0, zipcode#6]
                                                                                                                                                +- InMemoryRelation [xid#0, action#1, date#2, website_id#3, url#4, category_id#5, zipcode#6, device#7], StorageLevel(disk, memory, deserialized, 1 replicas)
                                                                                                                                                      +- AdaptiveSparkPlan isFinalPlan=true
               +- == Final Plan ==
                  ResultQueryStage 1
                  +- ShuffleQueryStage 0
                     +- Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=37]
                        +- *(1) ColumnarToRow
                           +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...
               +- == Initial Plan ==
                  Exchange hashpartitioning(xid#0, 20), REPARTITION_BY_NUM, [plan_id=22]
                  +- FileScan parquet [xid#0,action#1,date#2,website_id#3,url#4,category_id#5,zipcode#6,device#7] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.pa..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;xid:string,action:string,date:timestamp,website_id:string,url:string,category_id:float,zip...

Generated code:
/* 001 */ public Object generate(Object[] references) {
/* 002 */   return new GeneratedIteratorForCodegenStage14(references);
/* 003 */ }
/* 004 */
/* 005 */ // codegenStageId=14
/* 006 */ final class GeneratedIteratorForCodegenStage14 extends org.apache.spark.sql.execution.BufferedRowIterator {
/* 007 */   private Object[] references;
/* 008 */   private scala.collection.Iterator[] inputs;
/* 009 */   private boolean sort_needToSort_0;
/* 010 */   private org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter_0;
/* 011 */   private org.apache.spark.executor.TaskMetrics sort_metrics_0;
/* 012 */   private scala.collection.Iterator&lt;UnsafeRow&gt; sort_sortedIter_0;
/* 013 */   private scala.collection.Iterator inputadapter_input_0;
/* 014 */   private org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] project_mutableStateArray_0 = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[1];
/* 015 */
/* 016 */   public GeneratedIteratorForCodegenStage14(Object[] references) {
/* 017 */     this.references = references;
/* 018 */   }
/* 019 */
/* 020 */   public void init(int index, scala.collection.Iterator[] inputs) {
/* 021 */     partitionIndex = index;
/* 022 */     this.inputs = inputs;
/* 023 */     sort_needToSort_0 = true;
/* 024 */     sort_sorter_0 = ((org.apache.spark.sql.execution.SortExec) references[0] /* plan */).createSorter();
/* 025 */     sort_metrics_0 = org.apache.spark.TaskContext.get().taskMetrics();
/* 026 */
/* 027 */     inputadapter_input_0 = inputs[0];
/* 028 */     project_mutableStateArray_0[0] = new org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(23, 224);
/* 029 */
/* 030 */   }
/* 031 */
/* 032 */   private void sort_addToSorter_0() throws java.io.IOException {
/* 033 */     while ( inputadapter_input_0.hasNext()) {
/* 034 */       InternalRow inputadapter_row_0 = (InternalRow) inputadapter_input_0.next();
/* 035 */
/* 036 */       // common sub-expressions
/* 037 */
/* 038 */       boolean inputadapter_isNull_0 = inputadapter_row_0.isNullAt(0);
/* 039 */       UTF8String inputadapter_value_0 = inputadapter_isNull_0 ?
/* 040 */       null : (inputadapter_row_0.getUTF8String(0));
/* 041 */       boolean inputadapter_isNull_1 = inputadapter_row_0.isNullAt(1);
/* 042 */       UTF8String inputadapter_value_1 = inputadapter_isNull_1 ?
/* 043 */       null : (inputadapter_row_0.getUTF8String(1));
/* 044 */       boolean inputadapter_isNull_2 = inputadapter_row_0.isNullAt(2);
/* 045 */       long inputadapter_value_2 = inputadapter_isNull_2 ?
/* 046 */       -1L : (inputadapter_row_0.getLong(2));
/* 047 */       boolean inputadapter_isNull_3 = inputadapter_row_0.isNullAt(3);
/* 048 */       UTF8String inputadapter_value_3 = inputadapter_isNull_3 ?
/* 049 */       null : (inputadapter_row_0.getUTF8String(3));
/* 050 */       boolean inputadapter_isNull_4 = inputadapter_row_0.isNullAt(4);
/* 051 */       UTF8String inputadapter_value_4 = inputadapter_isNull_4 ?
/* 052 */       null : (inputadapter_row_0.getUTF8String(4));
/* 053 */       boolean inputadapter_isNull_5 = inputadapter_row_0.isNullAt(5);
/* 054 */       float inputadapter_value_5 = inputadapter_isNull_5 ?
/* 055 */       -1.0f : (inputadapter_row_0.getFloat(5));
/* 056 */       boolean inputadapter_isNull_6 = inputadapter_row_0.isNullAt(6);
/* 057 */       UTF8String inputadapter_value_6 = inputadapter_isNull_6 ?
/* 058 */       null : (inputadapter_row_0.getUTF8String(6));
/* 059 */       boolean inputadapter_isNull_7 = inputadapter_row_0.isNullAt(7);
/* 060 */       UTF8String inputadapter_value_7 = inputadapter_isNull_7 ?
/* 061 */       null : (inputadapter_row_0.getUTF8String(7));
/* 062 */       boolean inputadapter_isNull_8 = inputadapter_row_0.isNullAt(8);
/* 063 */       int inputadapter_value_8 = inputadapter_isNull_8 ?
/* 064 */       -1 : (inputadapter_row_0.getInt(8));
/* 065 */       boolean inputadapter_isNull_9 = inputadapter_row_0.isNullAt(9);
/* 066 */       UTF8String inputadapter_value_9 = inputadapter_isNull_9 ?
/* 067 */       null : (inputadapter_row_0.getUTF8String(9));
/* 068 */       long inputadapter_value_10 = inputadapter_row_0.getLong(10);
/* 069 */       boolean inputadapter_isNull_11 = inputadapter_row_0.isNullAt(11);
/* 070 */       double inputadapter_value_11 = inputadapter_isNull_11 ?
/* 071 */       -1.0 : (inputadapter_row_0.getDouble(11));
/* 072 */       boolean inputadapter_isNull_12 = inputadapter_row_0.isNullAt(12);
/* 073 */       int inputadapter_value_12 = inputadapter_isNull_12 ?
/* 074 */       -1 : (inputadapter_row_0.getInt(12));
/* 075 */       boolean inputadapter_isNull_13 = inputadapter_row_0.isNullAt(13);
/* 076 */       int inputadapter_value_13 = inputadapter_isNull_13 ?
/* 077 */       -1 : (inputadapter_row_0.getInt(13));
/* 078 */       boolean inputadapter_isNull_14 = inputadapter_row_0.isNullAt(14);
/* 079 */       int inputadapter_value_14 = inputadapter_isNull_14 ?
/* 080 */       -1 : (inputadapter_row_0.getInt(14));
/* 081 */       boolean inputadapter_isNull_15 = inputadapter_row_0.isNullAt(15);
/* 082 */       int inputadapter_value_15 = inputadapter_isNull_15 ?
/* 083 */       -1 : (inputadapter_row_0.getInt(15));
/* 084 */       long inputadapter_value_16 = inputadapter_row_0.getLong(16);
/* 085 */       long inputadapter_value_17 = inputadapter_row_0.getLong(17);
/* 086 */       long inputadapter_value_18 = inputadapter_row_0.getLong(18);
/* 087 */       boolean inputadapter_isNull_19 = inputadapter_row_0.isNullAt(19);
/* 088 */       double inputadapter_value_19 = inputadapter_isNull_19 ?
/* 089 */       -1.0 : (inputadapter_row_0.getDouble(19));
/* 090 */       long inputadapter_value_20 = inputadapter_row_0.getLong(20);
/* 091 */       long inputadapter_value_22 = inputadapter_row_0.getLong(22);
/* 092 */       long inputadapter_value_21 = inputadapter_row_0.getLong(21);
/* 093 */       project_mutableStateArray_0[0].reset();
/* 094 */
/* 095 */       project_mutableStateArray_0[0].zeroOutNullBytes();
/* 096 */
/* 097 */       if (inputadapter_isNull_0) {
/* 098 */         project_mutableStateArray_0[0].setNullAt(0);
/* 099 */       } else {
/* 100 */         project_mutableStateArray_0[0].write(0, inputadapter_value_0);
/* 101 */       }
/* 102 */
/* 103 */       if (inputadapter_isNull_1) {
/* 104 */         project_mutableStateArray_0[0].setNullAt(1);
/* 105 */       } else {
/* 106 */         project_mutableStateArray_0[0].write(1, inputadapter_value_1);
/* 107 */       }
/* 108 */
/* 109 */       if (inputadapter_isNull_2) {
/* 110 */         project_mutableStateArray_0[0].setNullAt(2);
/* 111 */       } else {
/* 112 */         project_mutableStateArray_0[0].write(2, inputadapter_value_2);
/* 113 */       }
/* 114 */
/* 115 */       if (inputadapter_isNull_3) {
/* 116 */         project_mutableStateArray_0[0].setNullAt(3);
/* 117 */       } else {
/* 118 */         project_mutableStateArray_0[0].write(3, inputadapter_value_3);
/* 119 */       }
/* 120 */
/* 121 */       if (inputadapter_isNull_4) {
/* 122 */         project_mutableStateArray_0[0].setNullAt(4);
/* 123 */       } else {
/* 124 */         project_mutableStateArray_0[0].write(4, inputadapter_value_4);
/* 125 */       }
/* 126 */
/* 127 */       if (inputadapter_isNull_5) {
/* 128 */         project_mutableStateArray_0[0].setNullAt(5);
/* 129 */       } else {
/* 130 */         project_mutableStateArray_0[0].write(5, inputadapter_value_5);
/* 131 */       }
/* 132 */
/* 133 */       if (inputadapter_isNull_6) {
/* 134 */         project_mutableStateArray_0[0].setNullAt(6);
/* 135 */       } else {
/* 136 */         project_mutableStateArray_0[0].write(6, inputadapter_value_6);
/* 137 */       }
/* 138 */
/* 139 */       if (inputadapter_isNull_7) {
/* 140 */         project_mutableStateArray_0[0].setNullAt(7);
/* 141 */       } else {
/* 142 */         project_mutableStateArray_0[0].write(7, inputadapter_value_7);
/* 143 */       }
/* 144 */
/* 145 */       if (inputadapter_isNull_8) {
/* 146 */         project_mutableStateArray_0[0].setNullAt(8);
/* 147 */       } else {
/* 148 */         project_mutableStateArray_0[0].write(8, inputadapter_value_8);
/* 149 */       }
/* 150 */
/* 151 */       if (inputadapter_isNull_9) {
/* 152 */         project_mutableStateArray_0[0].setNullAt(9);
/* 153 */       } else {
/* 154 */         project_mutableStateArray_0[0].write(9, inputadapter_value_9);
/* 155 */       }
/* 156 */
/* 157 */       project_mutableStateArray_0[0].write(10, inputadapter_value_10);
/* 158 */
/* 159 */       if (inputadapter_isNull_11) {
/* 160 */         project_mutableStateArray_0[0].setNullAt(11);
/* 161 */       } else {
/* 162 */         project_mutableStateArray_0[0].write(11, inputadapter_value_11);
/* 163 */       }
/* 164 */
/* 165 */       if (inputadapter_isNull_12) {
/* 166 */         project_mutableStateArray_0[0].setNullAt(12);
/* 167 */       } else {
/* 168 */         project_mutableStateArray_0[0].write(12, inputadapter_value_12);
/* 169 */       }
/* 170 */
/* 171 */       if (inputadapter_isNull_13) {
/* 172 */         project_mutableStateArray_0[0].setNullAt(13);
/* 173 */       } else {
/* 174 */         project_mutableStateArray_0[0].write(13, inputadapter_value_13);
/* 175 */       }
/* 176 */
/* 177 */       if (inputadapter_isNull_14) {
/* 178 */         project_mutableStateArray_0[0].setNullAt(14);
/* 179 */       } else {
/* 180 */         project_mutableStateArray_0[0].write(14, inputadapter_value_14);
/* 181 */       }
/* 182 */
/* 183 */       if (inputadapter_isNull_15) {
/* 184 */         project_mutableStateArray_0[0].setNullAt(15);
/* 185 */       } else {
/* 186 */         project_mutableStateArray_0[0].write(15, inputadapter_value_15);
/* 187 */       }
/* 188 */
/* 189 */       project_mutableStateArray_0[0].write(16, inputadapter_value_16);
/* 190 */
/* 191 */       project_mutableStateArray_0[0].write(17, inputadapter_value_17);
/* 192 */
/* 193 */       project_mutableStateArray_0[0].write(18, inputadapter_value_18);
/* 194 */
/* 195 */       if (inputadapter_isNull_19) {
/* 196 */         project_mutableStateArray_0[0].setNullAt(19);
/* 197 */       } else {
/* 198 */         project_mutableStateArray_0[0].write(19, inputadapter_value_19);
/* 199 */       }
/* 200 */
/* 201 */       project_mutableStateArray_0[0].write(20, inputadapter_value_20);
/* 202 */
/* 203 */       project_mutableStateArray_0[0].write(21, inputadapter_value_22);
/* 204 */
/* 205 */       project_mutableStateArray_0[0].write(22, inputadapter_value_21);
/* 206 */       sort_sorter_0.insertRow((UnsafeRow)(project_mutableStateArray_0[0].getRow()));
/* 207 */       // shouldStop check is eliminated
/* 208 */     }
/* 209 */
/* 210 */   }
/* 211 */
/* 212 */   protected void processNext() throws java.io.IOException {
/* 213 */     if (sort_needToSort_0) {
/* 214 */       long sort_spillSizeBefore_0 = sort_metrics_0.memoryBytesSpilled();
/* 215 */       sort_addToSorter_0();
/* 216 */       sort_sortedIter_0 = sort_sorter_0.sort();
/* 217 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[3] /* sortTime */).add(sort_sorter_0.getSortTimeNanos() / 1000000);
/* 218 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[1] /* peakMemory */).add(sort_sorter_0.getPeakMemoryUsage());
/* 219 */       ((org.apache.spark.sql.execution.metric.SQLMetric) references[2] /* spillSize */).add(sort_metrics_0.memoryBytesSpilled() - sort_spillSizeBefore_0);
/* 220 */       sort_metrics_0.incPeakExecutionMemory(sort_sorter_0.getPeakMemoryUsage());
/* 221 */       sort_needToSort_0 = false;
/* 222 */     }
/* 223 */
/* 224 */     while ( sort_sortedIter_0.hasNext()) {
/* 225 */       UnsafeRow sort_outputRow_0 = (UnsafeRow)sort_sortedIter_0.next();
/* 226 */
/* 227 */       append(sort_outputRow_0);
/* 228 */
/* 229 */       if (shouldStop()) return;
/* 230 */     }
/* 231 */   }
/* 232 */
/* 233 */ }

</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 18:===============================================&gt;        (17 + 3) / 20]                                                                                </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Again:</p>
<ul>
<li>How many jobs were triggered by <code>checkpoint()</code>?</li>
<li>How many stages? How many tasks?</li>
<li>Could you spot shuffle reads and writes?</li>
<li>Have a look at detailed plans on Spark UI.<br>
</li>
<li>In the physical plan, can you spot <code>WholeStageCodegen</code>? What is it for?</li>
<li>In the physical plan, can you spot <code>ShuffleQueryStage</code>? What does it stand for?</li>
</ul>
</div>
</div>
<div id="e3280fea" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">10000</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="275df8f0" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>sample_df <span class="op">=</span> (</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>      .sample(withReplacement<span class="op">=</span><span class="va">False</span>, fraction<span class="op">=</span><span class="fl">.05</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>      .repartition(<span class="st">'xid'</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="d28b5b1f" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>sample_df.count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>58872</code></pre>
</div>
</div>
<div id="ebd97c19" class="cell" data-execution_count="36">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> transformer <span class="kw">in</span> transformers:</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    sample_df <span class="op">=</span> transformer(sample_df)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_df.show(n=1)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c7f22556" class="cell" data-execution_count="37">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>sample_df.printSchema()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- xid: string (nullable = true)
 |-- action: string (nullable = true)
 |-- date: timestamp (nullable = true)
 |-- website_id: string (nullable = true)
 |-- url: string (nullable = true)
 |-- category_id: float (nullable = true)
 |-- zipcode: string (nullable = true)
 |-- device: string (nullable = true)
 |-- hour: integer (nullable = true)
 |-- weekday: string (nullable = true)
 |-- n_events: long (nullable = false)
 |-- n_days_since_last_event: double (nullable = true)
 |-- n_unique_day: integer (nullable = true)
 |-- n_unique_hour: integer (nullable = true)
 |-- n_device: integer (nullable = true)
 |-- n_unique_category_id: integer (nullable = true)
 |-- n_events_per_action: long (nullable = false)
 |-- n_events_per_hour: long (nullable = false)
 |-- n_events_per_weekday: long (nullable = false)
 |-- n_days_since_last_action: double (nullable = true)
 |-- n_events_per_device: long (nullable = false)
 |-- n_actions_per_category_id: long (nullable = false)
 |-- n_events_per_category_id: long (nullable = false)
 |-- n_events_per_website_id: long (nullable = false)
</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Call <code>explain(mode="codegen")</code> on the resulting dataframe.</p>
</div>
</div>
<div id="e7ea8b5e" class="cell" data-execution_count="38">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sample_df.explain(mode<span class="op">=</span><span class="st">"codegen"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="apply-transformers" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span>  perf_counter()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> transformer <span class="kw">in</span> transformers:</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> transformer(df)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>( </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        .sample(withReplacement<span class="op">=</span><span class="va">False</span>, fraction<span class="op">=</span><span class="fl">.05</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        .show(n<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(perf_counter() <span class="op">-</span>t0)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 29:&gt;                                                         (0 + 1) / 1]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+------+-------------------+----------+--------------------+-----------+-------+------+----+-------+--------+-----------------------+------------+-------------+--------+--------------------+-------------------+-----------------+--------------------+------------------------+-------------------+-------------------------+------------------------+-----------------------+
|                 xid|action|               date|website_id|                 url|category_id|zipcode|device|hour|weekday|n_events|n_days_since_last_event|n_unique_day|n_unique_hour|n_device|n_unique_category_id|n_events_per_action|n_events_per_hour|n_events_per_weekday|n_days_since_last_action|n_events_per_device|n_actions_per_category_id|n_events_per_category_id|n_events_per_website_id|
+--------------------+------+-------------------+----------+--------------------+-----------+-------+------+----+-------+--------+-----------------------+------------+-------------+--------+--------------------+-------------------+-----------------+--------------------+------------------------+-------------------+-------------------------+------------------------+-----------------------+
|00037ace-b22f-480...|     O|2017-01-22 18:57:34|        74|http://www.realit...|     1002.0|   NULL|   DSK|  18| Sunday|       6|                 3312.1|           1|            2|       1|                   2|                  6|                2|                   6|                  3312.1|                  6|                        4|                       4|                      6|
+--------------------+------+-------------------+----------+--------------------+-----------+-------+------+----+-------+--------+-----------------------+------------+-------------+--------+--------------------+-------------------+-----------------+--------------------+------------------------+-------------------+-------------------------+------------------------+-----------------------+
only showing top 1 row
1.3951444809999884</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="33a44cce" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df = df.repartition(20, 'xid')</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>df.checkpoint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 31:&gt;                                                       (0 + 20) / 20][Stage 31:==&gt;                                                     (1 + 19) / 20][Stage 31:=========================&gt;                              (9 + 11) / 20][Stage 31:============================================&gt;           (16 + 4) / 20]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>DataFrame[xid: string, action: string, date: timestamp, website_id: string, url: string, category_id: float, zipcode: string, device: string, hour: int, weekday: string, n_events: bigint, n_days_since_last_event: double, n_unique_day: int, n_unique_hour: int, n_device: int, n_unique_category_id: int, n_events_per_action: bigint, n_events_per_hour: bigint, n_events_per_weekday: bigint, n_days_since_last_action: double, n_events_per_device: bigint, n_actions_per_category_id: bigint, n_events_per_category_id: bigint, n_events_per_website_id: bigint]</code></pre>
</div>
</div>
<div id="d3cf829a" class="cell" data-execution_count="41">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>df.write.parquet(<span class="st">'file:///home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata-transformed.parquet'</span>, mode<span class="op">=</span><span class="st">'overwrite'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 33:&gt;                                                       (0 + 20) / 20][Stage 33:=========================&gt;                              (9 + 11) / 20]                                                                                </code></pre>
</div>
</div>
<div id="dbf6b9d2" class="cell" data-execution_count="42">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls <span class="op">-</span>l data<span class="op">/</span>webdata<span class="op">-</span>transformed.parquet<span class="op">/</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>total 42452
-rw-r--r-- 1 boucheron boucheron 2029216 févr. 16 10:03 part-00000-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2571583 févr. 16 10:03 part-00001-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2016855 févr. 16 10:03 part-00002-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1213194 févr. 16 10:03 part-00003-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2605526 févr. 16 10:03 part-00004-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1739664 févr. 16 10:03 part-00005-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2325113 févr. 16 10:03 part-00006-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2596096 févr. 16 10:03 part-00007-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2266491 févr. 16 10:03 part-00008-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2313765 févr. 16 10:03 part-00009-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2330433 févr. 16 10:03 part-00010-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2846406 févr. 16 10:03 part-00011-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1721613 févr. 16 10:03 part-00012-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2299943 févr. 16 10:03 part-00013-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1758838 févr. 16 10:03 part-00014-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1758969 févr. 16 10:03 part-00015-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1770399 févr. 16 10:03 part-00016-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2638662 févr. 16 10:03 part-00017-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 1771383 févr. 16 10:03 part-00018-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron 2855105 févr. 16 10:03 part-00019-fb0a5b92-5452-4a31-85b4-74b62147e995-c000.snappy.parquet
-rw-r--r-- 1 boucheron boucheron       0 févr. 16 10:03 _SUCCESS</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If things go wrong with the next message</p>
<p>In Spark SQL <code>local</code> mode, the heap size is controlled by the driver JVM, because in local mode the driver and executor run in the same process.</p>
<p>We can increase Java heap by increasing the driver memory.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> (</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    SparkSession</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>        .builder</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        .appName(<span class="st">"Taming Webdata"</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        .config(<span class="st">"spark.driver.memory"</span>, <span class="st">"16G"</span>) <span class="co"># The default is 5G</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>        .config(<span class="st">"spark.driver.maxResultSize"</span>, <span class="st">"0"</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        .getOrCreate()</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="459eb9db" class="cell" data-execution_count="43">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span>(df.columns)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>['action',
 'category_id',
 'date',
 'device',
 'hour',
 'n_actions_per_category_id',
 'n_days_since_last_action',
 'n_days_since_last_event',
 'n_device',
 'n_events',
 'n_events_per_action',
 'n_events_per_category_id',
 'n_events_per_device',
 'n_events_per_hour',
 'n_events_per_website_id',
 'n_events_per_weekday',
 'n_unique_category_id',
 'n_unique_day',
 'n_unique_hour',
 'url',
 'website_id',
 'weekday',
 'xid',
 'zipcode']</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How DRY-compliant is this code?</li>
<li>Should we dry it?</li>
<li>Why would we dry it (readability, maintainability, …)?</li>
<li>Rewrite the construction of the transformed dataframe using SQL. Compare the (final) execution plans.</li>
</ul>
</div>
</div>
</section>
<section id="load-step" class="level2">
<h2 class="anchored" data-anchor-id="load-step">Load step</h2>
<p>Here, we use all the previous computations (saved in the columns of the dataframe) to compute aggregated informations about each user.</p>
<div id="115b5051" class="cell" data-execution_count="44">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.read.parquet(</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'file:///home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata-transformed.parquet'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>All functions in the next chunk have one argument: a dataframe with schema</p>
<pre><code>root
 |-- xid: string (nullable = true)
 |-- action: string (nullable = true)
 |-- date: timestamp (nullable = true)
 |-- website_id: string (nullable = true)
 |-- url: string (nullable = true)
 |-- category_id: float (nullable = true)
 |-- zipcode: string (nullable = true)
 |-- device: string (nullable = true)
 |-- hour: integer (nullable = true)
 |-- weekday: string (nullable = true)
 |-- n_events_per_hour: long (nullable = false)
 |-- n_events_per_weekday: long (nullable = false)
 |-- n_days_since_last_event: double (nullable = true)
 |-- n_days_since_last_action: double (nullable = true)
 |-- n_unique_day: integer (nullable = true)
 |-- n_unique_hour: integer (nullable = true)
 |-- n_events_per_device: long (nullable = false)
 |-- n_device: integer (nullable = true)
 |-- n_actions_per_category_id: long (nullable = false)
 |-- n_events_per_category_id: long (nullable = false)
 |-- n_events_per_website_id: long (nullable = false)</code></pre>
<p>All functions in the next chunk return a dataframe with three columns: <code>xid</code>, <code>value</code>, <code>feature_name</code>. Column <code>value</code> is obtained by renaming a column <code>n_...</code> (built by one of the previous transformers). Column <code>feature_name</code></p>
</div>
</div>
<div id="9f82e526" class="cell" data-execution_count="45">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_hour_loader(df):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df<span class="op">\</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>        .select(<span class="st">'xid'</span>, <span class="st">'hour'</span>, <span class="st">'n_events_per_hour'</span>)<span class="op">\</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_events_per_hour'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>        .distinct()     <span class="co"># action</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_events_per_hour#'</span>), col(<span class="st">'hour'</span>))</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'hour'</span>)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_website_id_loader(df):</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'website_id'</span>, <span class="st">'n_events_per_website_id'</span>)<span class="op">\</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_events_per_website_id'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_events_per_website_id#'</span>),</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>                               col(<span class="st">'website_id'</span>))</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'website_id'</span>)</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_weekday_loader(df):</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df<span class="op">\</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        .select(<span class="st">'xid'</span>, <span class="st">'weekday'</span>, <span class="st">'n_events_per_weekday'</span>)<span class="op">\</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_events_per_weekday'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_events_per_weekday#'</span>), col(<span class="st">'weekday'</span>))</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'weekday'</span>)</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_days_since_last_event_loader(df):</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>,  <span class="st">'n_days_since_last_event'</span>)<span class="op">\</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_days_since_last_event#'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> lit(<span class="st">'n_days_since_last_event'</span>)</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_days_since_last_action_loader(df):</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'action'</span>, <span class="st">'n_days_since_last_action'</span>)<span class="op">\</span></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_days_since_last_action'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_days_since_last_action#'</span>), col(<span class="st">'action'</span>))</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'action'</span>)</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_day_loader(df):</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'n_unique_day'</span>)<span class="op">\</span></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_unique_day'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> lit(<span class="st">'n_unique_day'</span>)</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_hour_loader(df):</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'n_unique_hour'</span>)<span class="op">\</span></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_unique_hour'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> lit(<span class="st">'n_unique_hour'</span>)</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_device_loader(df):</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df<span class="op">\</span></span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>        .select(<span class="st">'xid'</span>, <span class="st">'device'</span>, <span class="st">'n_events_per_device'</span>)<span class="op">\</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_events_per_device'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_events_per_device#'</span>), col(<span class="st">'device'</span>))</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'device'</span>)</span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_unique_device_loader(df):</span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'n_device'</span>)<span class="op">\</span></span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_device'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> lit(<span class="st">'n_device'</span>)</span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)</span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_category_id_loader(df):</span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'category_id'</span>, <span class="st">'n_events_per_category_id'</span>)<span class="op">\</span></span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_events_per_category_id'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_events_per_category_id#'</span>),</span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>                               col(<span class="st">'category_id'</span>))</span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'category_id'</span>)</span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_actions_per_category_id_loader(df):</span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'category_id'</span>, <span class="st">'action'</span>, <span class="st">'n_actions_per_category_id'</span>)<span class="op">\</span></span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_actions_per_category_id'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_actions_per_category_id#'</span>),</span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a>                               col(<span class="st">'action'</span>), lit(<span class="st">'#'</span>), </span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>                               col(<span class="st">'category_id'</span>))</span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'category_id'</span>)<span class="op">\</span></span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'action'</span>)</span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_events_per_website_id_loader(df):</span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> df.select(<span class="st">'xid'</span>, <span class="st">'website_id'</span>, <span class="st">'n_events_per_website_id'</span>)<span class="op">\</span></span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a>        .withColumnRenamed(<span class="st">'n_events_per_website_id'</span>, <span class="st">'value'</span>)<span class="op">\</span></span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> func.concat(lit(<span class="st">'n_events_per_website_id#'</span>),</span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>                               col(<span class="st">'website_id'</span>))</span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a>    csr <span class="op">=</span> csr<span class="op">\</span></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'feature_name'</span>, feature_name)<span class="op">\</span></span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">'website_id'</span>)</span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How DRY-compliant is this code (bis)?</li>
<li>Should we dry it?</li>
<li>Why would we dry it (readability, maintainability, …)?</li>
</ul>
</div>
</div>
<div id="d85dd6ac" class="cell" data-execution_count="46">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>        .select(<span class="st">'xid'</span>, </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_unique_day'</span>, </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_unique_hour'</span>, </span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_days_since_last_event'</span>,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_device'</span>)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>        .unpivot(ids<span class="op">=</span><span class="st">'xid'</span>, </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>                 values <span class="op">=</span> [<span class="st">'n_unique_day'</span>, </span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'n_unique_hour'</span>, </span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'n_days_since_last_event'</span>, </span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'n_device'</span>],</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>                 variableColumnName<span class="op">=</span><span class="st">'feature_name'</span>,</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>                 valueColumnName<span class="op">=</span><span class="st">'value'</span>)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>        .show(<span class="dv">20</span>)</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+--------------------+------+
|                 xid|        feature_name| value|
+--------------------+--------------------+------+
|00037ace-b22f-480...|        n_unique_day|   1.0|
|00037ace-b22f-480...|       n_unique_hour|   2.0|
|00037ace-b22f-480...|n_days_since_last...|3312.1|
|00037ace-b22f-480...|            n_device|   1.0|
|00043755-8e16-42b...|        n_unique_day|   1.0|
|00043755-8e16-42b...|       n_unique_hour|   1.0|
|00043755-8e16-42b...|n_days_since_last...|3318.1|
|00043755-8e16-42b...|            n_device|   1.0|
|000676b2-dd4b-4d4...|        n_unique_day|   1.0|
|000676b2-dd4b-4d4...|       n_unique_hour|   1.0|
|000676b2-dd4b-4d4...|n_days_since_last...|3301.1|
|000676b2-dd4b-4d4...|            n_device|   1.0|
|0008c5d2-c263-4b5...|        n_unique_day|   1.0|
|0008c5d2-c263-4b5...|       n_unique_hour|   1.0|
|0008c5d2-c263-4b5...|n_days_since_last...|3318.1|
|0008c5d2-c263-4b5...|            n_device|   1.0|
|000a421d-371f-492...|        n_unique_day|   1.0|
|000a421d-371f-492...|       n_unique_hour|   1.0|
|000a421d-371f-492...|n_days_since_last...|3334.1|
|000a421d-371f-492...|            n_device|   1.0|
+--------------------+--------------------+------+
only showing top 20 rows</code></pre>
</div>
</div>
<div id="eb0d794f" class="cell" data-execution_count="47">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>()</code></pre>
</div>
</div>
<div id="b1a2bc0c" class="cell" data-execution_count="48">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>loaders <span class="op">=</span> [</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    n_events_per_hour_loader,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    n_events_per_website_id_loader,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    n_events_per_weekday_loader,</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    n_days_since_last_event_loader,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    n_days_since_last_action_loader,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    n_unique_day_loader,</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    n_unique_hour_loader,</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    n_events_per_device_loader,</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    n_unique_device_loader,</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    n_events_per_category_id_loader,</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    n_actions_per_category_id_loader,</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    n_events_per_website_id_loader,</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="7c35da89" class="cell" data-execution_count="49">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> union(df, other):</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.union(other)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="About DataFrame.union()">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>About DataFrame.union()
</div>
</div>
<div class="callout-body-container callout-body">
<p>This method performs a SQL-style set union of the rows from both DataFrame objects, with no automatic deduplication of elements.</p>
<p>Use the <code>distinct()</code> method to perform deduplication of rows.</p>
<p>The method resolves columns by position (not by name), following the standard behavior in SQL.</p>
</div>
</div>
<div id="50abe7bd" class="cell" data-execution_count="50">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> perf_counter()</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>spam <span class="op">=</span> [loader(df) <span class="cf">for</span> loader <span class="kw">in</span> loaders]</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>perf_counter() <span class="op">-</span> t0</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>0.13093846700030554</code></pre>
</div>
</div>
<div id="c12b05ef" class="cell" data-execution_count="51">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>spam[<span class="dv">0</span>].printSchema()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- xid: string (nullable = true)
 |-- value: long (nullable = false)
 |-- feature_name: string (nullable = true)
</code></pre>
</div>
</div>
<div id="56a441f7" class="cell" data-execution_count="52">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(spam)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>12</code></pre>
</div>
</div>
<div id="97cdf6c5" class="cell" data-execution_count="53">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> perf_counter()</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>csr <span class="op">=</span> <span class="bu">reduce</span>(</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> df1, df2: df1.union(df2),</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    spam</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>csr.show(n<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>perf_counter() <span class="op">-</span> t0</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+-----+--------------------+
|                 xid|value|        feature_name|
+--------------------+-----+--------------------+
|00037ace-b22f-480...|  2.0|n_events_per_hour#18|
|00037ace-b22f-480...|  4.0|n_events_per_hour#19|
|00043755-8e16-42b...|  1.0|n_events_per_hour#12|
+--------------------+-----+--------------------+
only showing top 3 rows</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>1.0603654340002322</code></pre>
</div>
</div>
<div id="033ae6a3" class="cell" data-execution_count="54">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>csr.columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>['xid', 'value', 'feature_name']</code></pre>
</div>
</div>
<div id="cc0b04ae" class="cell" data-execution_count="55">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>csr.show(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+-----+--------------------+
|                 xid|value|        feature_name|
+--------------------+-----+--------------------+
|00037ace-b22f-480...|  2.0|n_events_per_hour#18|
|00037ace-b22f-480...|  4.0|n_events_per_hour#19|
|00043755-8e16-42b...|  1.0|n_events_per_hour#12|
|000676b2-dd4b-4d4...|  1.0|n_events_per_hour#17|
|0008c5d2-c263-4b5...|  1.0| n_events_per_hour#4|
+--------------------+-----+--------------------+
only showing top 5 rows</code></pre>
</div>
</div>
<div id="986635bb" class="cell" data-execution_count="56">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>csr.rdd.getNumPartitions()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>20</code></pre>
</div>
</div>
<div id="bfe0ec9b" class="cell" data-execution_count="57">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>feature_name_partition <span class="op">=</span> Window().orderBy(<span class="st">'feature_name'</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>fn_idx <span class="op">=</span> (</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    csr</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>        .select(<span class="st">'feature_name'</span>)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'col'</span>, func.row_number().over(feature_name_partition))</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="5f1c33c4" class="cell" data-execution_count="58">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>fn_idx.cache()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:06 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:06 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:06 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>DataFrame[feature_name: string, col: int]</code></pre>
</div>
</div>
<div id="82a1d2bb" class="cell" data-execution_count="59">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>csr <span class="op">=</span> ( </span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    csr</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>        .join(fn_idx, <span class="st">'feature_name'</span>)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>csr.show(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:07 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:07 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 41:=====&gt;                                                (25 + 20) / 240][Stage 41:=========&gt;                                            (41 + 20) / 240][Stage 41:============&gt;                                         (55 + 20) / 240][Stage 41:=================&gt;                                    (79 + 20) / 240][Stage 41:==================&gt;                                   (80 + 20) / 240][Stage 41:======================&gt;                              (100 + 20) / 240][Stage 41:======================&gt;                              (103 + 21) / 240][Stage 41:==========================&gt;                          (120 + 20) / 240][Stage 41:==============================&gt;                      (140 + 20) / 240][Stage 41:===============================&gt;                     (143 + 21) / 240][Stage 41:===================================&gt;                 (160 + 20) / 240][Stage 41:=======================================&gt;             (180 + 20) / 240][Stage 41:========================================&gt;            (182 + 20) / 240][Stage 41:============================================&gt;        (201 + 20) / 240][Stage 41:================================================&gt;    (218 + 21) / 240]26/02/16 10:03:11 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:11 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:11 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:11 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
                                                                                [Stage 54:&gt;                                                       (0 + 20) / 20][Stage 54:==&gt;                                                     (1 + 19) / 20][Stage 54:===============================================&gt;        (17 + 3) / 20]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+--------------------+-----+---+
|        feature_name|                 xid|value|col|
+--------------------+--------------------+-----+---+
|n_events_per_webs...|00b0dd52-ba6f-4c9...|  2.0| 57|
|n_events_per_webs...|012eae8a-3ca2-428...|  1.0| 57|
|n_events_per_webs...|02410328-85b2-4b4...|  1.0| 57|
|n_events_per_webs...|03412f95-946c-4b2...|  1.0| 57|
|n_events_per_webs...|03d5202b-f64b-42e...|  1.0| 57|
|n_events_per_webs...|0465a601-3171-435...|  1.0| 57|
|n_events_per_webs...|0516e7da-7c78-41f...|  1.0| 57|
|n_events_per_webs...|056189c9-f926-460...|  1.0| 57|
|n_events_per_webs...|05d8404b-c83b-48a...|  1.0| 57|
|n_events_per_webs...|064b6d87-25b1-4f5...|  1.0| 57|
+--------------------+--------------------+-----+---+
only showing top 10 rows</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="3bdcc70c" class="cell" data-execution_count="60">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace features names and xid by a unique number</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>feature_name_partition <span class="op">=</span> Window().orderBy(<span class="st">'feature_name'</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>col_idx <span class="op">=</span> func.dense_rank().over(feature_name_partition)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="dd0efb6e" class="cell" data-execution_count="61">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>xid_partition <span class="op">=</span> Window().orderBy(<span class="st">'xid'</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>row_idx <span class="op">=</span> func.dense_rank().over(xid_partition)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="13ff1a60" class="cell" data-execution_count="62">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>csr <span class="op">=</span> (</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    csr</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co">#        .withColumn('col', col_idx)</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>        .withColumn(<span class="st">'row'</span>, row_idx)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="756540ce" class="cell" data-execution_count="63">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>csr <span class="op">=</span> csr.na.drop(<span class="st">'any'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="d2986537" class="cell" data-execution_count="64">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>csr.show(n<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:16 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 63:&gt;                                                       (0 + 20) / 20]26/02/16 10:03:20 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:20 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 66:&gt;                                                         (0 + 1) / 1]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+--------------------+------+---+---+
|        feature_name|                 xid| value|col|row|
+--------------------+--------------------+------+---+---+
|n_events_per_hour#17|00008f69-9f2f-445...|   1.0| 26|  1|
|n_events_per_webs...|00008f69-9f2f-445...|   1.0| 61|  1|
|n_events_per_week...|00008f69-9f2f-445...|   1.0|101|  1|
|n_days_since_last...|00008f69-9f2f-445...|3308.1|  8|  1|
|n_days_since_last...|00008f69-9f2f-445...|3308.1|  7|  1|
+--------------------+--------------------+------+---+---+
only showing top 5 rows</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="be9b4cf4" class="cell" data-execution_count="65">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's save the result of our hard work into a new parquet file (in the local filesystem)</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> os.path.abspath(<span class="st">'./data'</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">'file://'</span> <span class="op">+</span> output_path <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span> <span class="st">'csr.parquet'</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>csr.write.parquet(output_file, mode<span class="op">=</span><span class="st">'overwrite'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:22 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 72:&gt;                                                       (0 + 20) / 20][Stage 72:=====================================================&gt;  (19 + 1) / 20]26/02/16 10:03:26 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:26 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 75:&gt;                                                         (0 + 1) / 1]                                                                                </code></pre>
</div>
</div>
<div id="4ab45ba1" class="cell" data-execution_count="66">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save  the result  to hdfs</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>csr.write.parquet(<span class="st">'csr.parquet'</span>, mode<span class="op">=</span><span class="st">'overwrite'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="preparation-of-the-training-dataset" class="level1">
<h1>Preparation of the training dataset</h1>
<div id="3e78e0df" class="cell" data-execution_count="67">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>input_path <span class="op">=</span> os.path.abspath(<span class="st">'./data'</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>csr_file <span class="op">=</span> <span class="st">'file://'</span> <span class="op">+</span> input_path <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span> <span class="st">'csr.parquet'</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.read.parquet(csr_file)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>df.head(n<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>[Row(feature_name='n_events_per_hour#17', xid='00008f69-9f2f-4453-80ec-98b4ae8a3085', value=1.0, col=26, row=1),
 Row(feature_name='n_events_per_website_id#3', xid='00008f69-9f2f-4453-80ec-98b4ae8a3085', value=1.0, col=61, row=1),
 Row(feature_name='n_events_per_weekday#Thursday', xid='00008f69-9f2f-4453-80ec-98b4ae8a3085', value=1.0, col=101, row=1),
 Row(feature_name='n_days_since_last_event', xid='00008f69-9f2f-4453-80ec-98b4ae8a3085', value=3308.1, col=8, row=1),
 Row(feature_name='n_days_since_last_action#O', xid='00008f69-9f2f-4453-80ec-98b4ae8a3085', value=3308.1, col=7, row=1)]</code></pre>
</div>
</div>
<div id="14358e7a" class="cell" data-execution_count="68">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>df.count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>5860593</code></pre>
</div>
</div>
<div id="b8c2c472" class="cell" data-execution_count="69">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What are the features related to category_id 1204 ?</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>features_names <span class="op">=</span> <span class="op">\</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    df.select(<span class="st">'feature_name'</span>)<span class="op">\</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    .distinct()<span class="op">\</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    .toPandas()[<span class="st">'feature_name'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="502ec60f" class="cell" data-execution_count="70">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>features_names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>0       n_events_per_website_id#25
1      n_events_per_weekday#Sunday
2       n_events_per_website_id#42
3              n_events_per_hour#0
4       n_events_per_website_id#22
                  ...             
99      n_events_per_website_id#29
100     n_events_per_website_id#60
101    n_events_per_weekday#Monday
102     n_events_per_website_id#47
103     n_events_per_website_id#32
Name: feature_name, Length: 104, dtype: str</code></pre>
</div>
</div>
<div id="3e099e7e" class="cell" data-execution_count="71">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>[feature_name <span class="cf">for</span> feature_name <span class="kw">in</span> features_names <span class="cf">if</span> <span class="st">'1204'</span> <span class="kw">in</span> feature_name]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>['n_events_per_category_id#1204.0',
 'n_actions_per_category_id#C#1204.0',
 'n_actions_per_category_id#O#1204.0']</code></pre>
</div>
</div>
<div id="d636cb2d" class="cell" data-execution_count="72">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look for the xid that have at least one exposure to campaign 1204</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>keep <span class="op">=</span> func.when(</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    (col(<span class="st">'feature_name'</span>) <span class="op">==</span> <span class="st">'n_actions_per_category_id#C#1204.0'</span>) <span class="op">|</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    (col(<span class="st">'feature_name'</span>) <span class="op">==</span> <span class="st">'n_actions_per_category_id#O#1204.0'</span>),</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>).otherwise(<span class="dv">0</span>)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">'keep'</span>, keep)</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>df.where(col(<span class="st">'keep'</span>) <span class="op">&gt;</span> <span class="dv">0</span>).count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>153545</code></pre>
</div>
</div>
<div id="b5614e2f" class="cell" data-execution_count="73">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sum of the keeps :)</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>xid_partition <span class="op">=</span> Window.partitionBy(<span class="st">'xid'</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>sum_keep <span class="op">=</span> func.<span class="bu">sum</span>(col(<span class="st">'keep'</span>)).over(xid_partition)</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">'sum_keep'</span>, sum_keep)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="0919ff87" class="cell" data-execution_count="74">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's keep the xid exposed to 1204</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.where(col(<span class="st">'sum_keep'</span>) <span class="op">&gt;</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="b51a8df8" class="cell" data-execution_count="75">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>df.count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 88:===================================================&gt;     (9 + 1) / 10]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>1937035</code></pre>
</div>
</div>
<div id="aaea53ef" class="cell" data-execution_count="76">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>df.select(<span class="st">'xid'</span>).distinct().count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 94:===================================================&gt;     (9 + 1) / 10]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>152347</code></pre>
</div>
</div>
<div id="7f92d92b" class="cell" data-execution_count="77">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>row_partition <span class="op">=</span> Window().orderBy(<span class="st">'row'</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>col_partition <span class="op">=</span> Window().orderBy(<span class="st">'col'</span>)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>row_new <span class="op">=</span> func.dense_rank().over(row_partition)</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>col_new <span class="op">=</span> func.dense_rank().over(col_partition)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">'row_new'</span>, row_new)</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">'col_new'</span>, col_new)</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>csr_data <span class="op">=</span> df.select(<span class="st">'row_new'</span>, <span class="st">'col_new'</span>, <span class="st">'value'</span>).toPandas()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:37 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:37 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:37 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:37 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:37 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 100:==================================================&gt;     (9 + 1) / 10]26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 102:====================================================&gt;  (21 + 1) / 22]26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:39 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 105:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
</div>
<div id="3e583550" class="cell" data-execution_count="78">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>csr_data.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="71">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">row_new</th>
<th data-quarto-table-cell-role="th">col_new</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>221</td>
<td>1</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>998</td>
<td>1</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2079</td>
<td>1</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2712</td>
<td>1</td>
<td>9.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2961</td>
<td>1</td>
<td>4.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="2fdba9eb" class="cell" data-execution_count="79">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>features_names <span class="op">=</span> (</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>        .select(<span class="st">'feature_name'</span>, <span class="st">'col_new'</span>)</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>        .distinct()</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    features_names</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>        .where(col(<span class="st">'feature_name'</span>) <span class="op">==</span> <span class="st">'n_actions_per_category_id#C#1204.0'</span>)</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>        .head()</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:45 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:45 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:45 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 106:==================================================&gt;     (9 + 1) / 10]26/02/16 10:03:47 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:47 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:48 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:48 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>Row(feature_name='n_actions_per_category_id#C#1204.0', col_new=2)</code></pre>
</div>
</div>
<div id="e6429f2f" class="cell" data-execution_count="80">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    features_names</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>        .where(col(<span class="st">'feature_name'</span>) <span class="op">==</span> <span class="st">'n_actions_per_category_id#O#1204.0'</span>)</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>        .head()</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:48 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:48 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:48 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 112:==================================================&gt;     (9 + 1) / 10]26/02/16 10:03:50 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:50 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:50 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:50 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>Row(feature_name='n_actions_per_category_id#O#1204.0', col_new=4)</code></pre>
</div>
</div>
<div id="0acc0347" class="cell" data-execution_count="81">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> csr_data[<span class="st">'row_new'</span>].values <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> csr_data[<span class="st">'col_new'</span>].values <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>vals <span class="op">=</span> csr_data[<span class="st">'value'</span>].values</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>X_csr <span class="op">=</span> csr_matrix((vals, (rows, cols)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="9715f56e" class="cell" data-execution_count="82">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>X_csr.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>(152347, 92)</code></pre>
</div>
</div>
<div id="7c83a675" class="cell" data-execution_count="83">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>X_csr.shape, X_csr.nnz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>((152347, 92), 1783847)</code></pre>
</div>
</div>
<div id="a21be78b" class="cell" data-execution_count="84">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>X_csr.nnz <span class="op">/</span> (X_csr.shape[<span class="dv">0</span>]<span class="op">*</span> X_csr.shape[<span class="dv">1</span>])   <span class="co"># 0152347 * 92)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>0.12727287904814552</code></pre>
</div>
</div>
<div id="7be31850" class="cell" data-execution_count="85">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The label vector. Let's make it dense, flat and binary</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array(X_csr[:, <span class="dv">1</span>].todense()).ravel()</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array(y <span class="op">&gt;</span> <span class="dv">0</span>, dtype<span class="op">=</span>np.int64)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="3292220e" class="cell" data-execution_count="86">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>X_csr.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>(152347, 92)</code></pre>
</div>
</div>
<div id="3ba3b295" class="cell" data-execution_count="87">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We remove the second and fourth column. </span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># It actually contain the label we'll want to predict.</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>kept_cols <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(X_csr.shape[<span class="dv">1</span>]))</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>kept_cols.pop(<span class="dv">1</span>)</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>kept_cols.pop(<span class="dv">2</span>)</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> X_csr[:, kept_cols]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="d349386e" class="cell" data-execution_count="88">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(kept_cols)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>90</code></pre>
</div>
</div>
<div id="592f8c44" class="cell" data-execution_count="89">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>X_csr.shape, X.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>((152347, 92), (152347, 90))</code></pre>
</div>
</div>
<section id="finally" class="level2">
<h2 class="anchored" data-anchor-id="finally">Finally !!</h2>
<p>Wow ! That was a lot of work. Now we have a features matrix <span class="math inline">\(X\)</span> and a vector of labels <span class="math inline">\(y\)</span>.</p>
<div id="6e9e7a56" class="cell" data-execution_count="90">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>X.indices</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>array([ 3,  4,  5, ..., 85, 88, 89], shape=(1630302,), dtype=int32)</code></pre>
</div>
</div>
<div id="b9432695" class="cell" data-execution_count="91">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>X.indptr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>array([      0,      10,      20, ..., 1630282, 1630292, 1630302],
      shape=(152348,), dtype=int32)</code></pre>
</div>
</div>
<div id="e38cf695" class="cell" data-execution_count="92">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>X.shape, X.nnz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>((152347, 90), 1630302)</code></pre>
</div>
</div>
<div id="f6395f73" class="cell" data-execution_count="93">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>y.shape, y.<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>((152347,), np.int64(1594))</code></pre>
</div>
</div>
</section>
</section>
<section id="some-learning-forfrom-this-data" class="level1">
<h1>Some learning for/from this data</h1>
<div id="7f5d8e05" class="cell" data-execution_count="94">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize the features</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> MaxAbsScaler().fit_transform(X)</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, stratify<span class="op">=</span>y, test_size<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> LogisticRegression(</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>    penalty<span class="op">=</span><span class="st">'l2'</span>,</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span><span class="fl">1e3</span>,</span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>    solver<span class="op">=</span><span class="st">'lbfgs'</span>,</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>    class_weight<span class="op">=</span><span class="st">'balanced'</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>clf.fit(X_train, y_train)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/home/boucheron/Documents/IFEBY310/.nlp-venv/lib/python3.12/site-packages/sklearn/linear_model/_logistic.py:1135: FutureWarning:

'penalty' was deprecated in version 1.8 and will be removed in 1.10. To avoid this warning, leave 'penalty' set to its default value and use 'l1_ratio' or 'C' instead. Use l1_ratio=0 instead of penalty='l2', l1_ratio=1 instead of penalty='l1', and C=np.inf instead of penalty=None.
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="87">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;
}

#sk-container-id-1.light {
  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: black;
  --sklearn-color-background: white;
  --sklearn-color-border-box: black;
  --sklearn-color-icon: #696969;
}

#sk-container-id-1.dark {
  --sklearn-color-text-on-default-background: white;
  --sklearn-color-background: #111;
  --sklearn-color-border-box: white;
  --sklearn-color-icon: #878787;
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: center;
  justify-content: center;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  display: none;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  display: block;
  width: 100%;
  overflow: visible;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-unfitted-level-0);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-3) 1pt solid;
  color: var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3) 1pt solid;
  color: var(--sklearn-color-fitted-level-3);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  border: var(--sklearn-color-fitted-level-0) 1pt solid;
  color: var(--sklearn-color-unfitted-level-0);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  border: var(--sklearn-color-fitted-level-0) 1pt solid;
  color: var(--sklearn-color-fitted-level-0);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-unfitted-level-0);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}

.estimator-table {
    font-family: monospace;
}

.estimator-table summary {
    padding: .5rem;
    cursor: pointer;
}

.estimator-table summary::marker {
    font-size: 0.7rem;
}

.estimator-table details[open] {
    padding-left: 0.1rem;
    padding-right: 0.1rem;
    padding-bottom: 0.3rem;
}

.estimator-table .parameters-table {
    margin-left: auto !important;
    margin-right: auto !important;
    margin-top: 0;
}

.estimator-table .parameters-table tr:nth-child(odd) {
    background-color: #fff;
}

.estimator-table .parameters-table tr:nth-child(even) {
    background-color: #f6f6f6;
}

.estimator-table .parameters-table tr:hover {
    background-color: #e0e0e0;
}

.estimator-table table td {
    border: 1px solid rgba(106, 105, 104, 0.232);
}

/*
    `table td`is set in notebook with right text-align.
    We need to overwrite it.
*/
.estimator-table table td.param {
    text-align: left;
    position: relative;
    padding: 0;
}

.user-set td {
    color:rgb(255, 94, 0);
    text-align: left !important;
}

.user-set td.value {
    color:rgb(255, 94, 0);
    background-color: transparent;
}

.default td {
    color: black;
    text-align: left !important;
}

.user-set td i,
.default td i {
    color: black;
}

/*
    Styles for parameter documentation links
    We need styling for visited so jupyter doesn't overwrite it
*/
a.param-doc-link,
a.param-doc-link:link,
a.param-doc-link:visited {
    text-decoration: underline dashed;
    text-underline-offset: .3em;
    color: inherit;
    display: block;
    padding: .5em;
}

/* "hack" to make the entire area of the cell containing the link clickable */
a.param-doc-link::before {
    position: absolute;
    content: "";
    inset: 0;
}

.param-doc-description {
    display: none;
    position: absolute;
    z-index: 9999;
    left: 0;
    padding: .5ex;
    margin-left: 1.5em;
    color: var(--sklearn-color-text);
    box-shadow: .3em .3em .4em #999;
    width: max-content;
    text-align: left;
    max-height: 10em;
    overflow-y: auto;

    /* unfitted */
    background: var(--sklearn-color-unfitted-level-0);
    border: thin solid var(--sklearn-color-unfitted-level-3);
}

/* Fitted state for parameter tooltips */
.fitted .param-doc-description {
    /* fitted */
    background: var(--sklearn-color-fitted-level-0);
    border: thin solid var(--sklearn-color-fitted-level-3);
}

.param-doc-link:hover .param-doc-description {
    display: block;
}

.copy-paste-icon {
    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);
    background-repeat: no-repeat;
    background-size: 14px 14px;
    background-position: 0;
    display: inline-block;
    width: 14px;
    height: 14px;
    cursor: pointer;
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>LogisticRegression(C=1000.0, class_weight='balanced', penalty='l2')</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>LogisticRegression</div></div><div><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html">?<span>Documentation for LogisticRegression</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted" data-param-prefix="">
        <div class="estimator-table">
            <details>
                <summary>Parameters</summary>
                
<table class="parameters-table caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<tbody>
<tr class="user-set odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=penalty,-%7B%27l1%27%2C%20%27l2%27%2C%20%27elasticnet%27%2C%20None%7D%2C%20default%3D%27l2%27" class="param-doc-link" rel="noreferrer" target="_blank">penalty <span class="param-doc-description">penalty: {'l1', 'l2', 'elasticnet', None}, default='l2'<br>
<br>
Specify the norm of the penalty:<br>
<br>
- `None`: no penalty is added;<br>
- `'l2'`: add a L2 penalty term and it is the default choice;<br>
- `'l1'`: add a L1 penalty term;<br>
- `'elasticnet'`: both L1 and L2 penalty terms are added.<br>
<br>
.. warning::<br>
Some penalties may not work with some solvers. See the parameter<br>
`solver` below, to know the compatibility between the penalty and<br>
solver.<br>
<br>
.. versionadded:: 0.19<br>
l1 penalty with SAGA solver (allowing 'multinomial' + L1)<br>
<br>
.. deprecated:: 1.8<br>
`penalty` was deprecated in version 1.8 and will be removed in 1.10.<br>
Use `l1_ratio` instead. `l1_ratio=0` for `penalty='l2'`, `l1_ratio=1` for<br>
`penalty='l1'` and `l1_ratio` set to any float between 0 and 1 for<br>
`'penalty='elasticnet'`.</span></a></td>
<td class="value">'l2'</td>
</tr>
<tr class="user-set even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=C,-float%2C%20default%3D1.0" class="param-doc-link" rel="noreferrer" target="_blank">C <span class="param-doc-description">C: float, default=1.0<br>
<br>
Inverse of regularization strength; must be a positive float.<br>
Like in support vector machines, smaller values specify stronger<br>
regularization. `C=np.inf` results in unpenalized logistic regression.<br>
For a visual example on the effect of tuning the `C` parameter<br>
with an L1 penalty, see:<br>
:ref:`sphx_glr_auto_examples_linear_model_plot_logistic_path.py`.</span></a></td>
<td class="value">1000.0</td>
</tr>
<tr class="default odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=l1_ratio,-float%2C%20default%3D0.0" class="param-doc-link" rel="noreferrer" target="_blank">l1_ratio <span class="param-doc-description">l1_ratio: float, default=0.0<br>
<br>
The Elastic-Net mixing parameter, with `0 &lt;= l1_ratio &lt;= 1`. Setting<br>
`l1_ratio=1` gives a pure L1-penalty, setting `l1_ratio=0` a pure L2-penalty.<br>
Any value between 0 and 1 gives an Elastic-Net penalty of the form<br>
`l1_ratio * L1 + (1 - l1_ratio) * L2`.<br>
<br>
.. warning::<br>
Certain values of `l1_ratio`, i.e. some penalties, may not work with some<br>
solvers. See the parameter `solver` below, to know the compatibility between<br>
the penalty and solver.<br>
<br>
.. versionchanged:: 1.8<br>
Default value changed from None to 0.0.<br>
<br>
.. deprecated:: 1.8<br>
`None` is deprecated and will be removed in version 1.10. Always use<br>
`l1_ratio` to specify the penalty type.</span></a></td>
<td class="value">0.0</td>
</tr>
<tr class="default even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=dual,-bool%2C%20default%3DFalse" class="param-doc-link" rel="noreferrer" target="_blank">dual <span class="param-doc-description">dual: bool, default=False<br>
<br>
Dual (constrained) or primal (regularized, see also<br>
:ref:`this equation <regularized-logistic-loss>`) formulation. Dual formulation<br>
is only implemented for l2 penalty with liblinear solver. Prefer `dual=False`<br>
when n_samples &gt; n_features.</regularized-logistic-loss></span></a></td>
<td class="value">False</td>
</tr>
<tr class="default odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=tol,-float%2C%20default%3D1e-4" class="param-doc-link" rel="noreferrer" target="_blank">tol <span class="param-doc-description">tol: float, default=1e-4<br>
<br>
Tolerance for stopping criteria.</span></a></td>
<td class="value">0.0001</td>
</tr>
<tr class="default even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=fit_intercept,-bool%2C%20default%3DTrue" class="param-doc-link" rel="noreferrer" target="_blank">fit_intercept <span class="param-doc-description">fit_intercept: bool, default=True<br>
<br>
Specifies if a constant (a.k.a. bias or intercept) should be<br>
added to the decision function.</span></a></td>
<td class="value">True</td>
</tr>
<tr class="default odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=intercept_scaling,-float%2C%20default%3D1" class="param-doc-link" rel="noreferrer" target="_blank">intercept_scaling <span class="param-doc-description">intercept_scaling: float, default=1<br>
<br>
Useful only when the solver `liblinear` is used<br>
and `self.fit_intercept` is set to `True`. In this case, `x` becomes<br>
`[x, self.intercept_scaling]`,<br>
i.e. a "synthetic" feature with constant value equal to<br>
`intercept_scaling` is appended to the instance vector.<br>
The intercept becomes<br>
``intercept_scaling * synthetic_feature_weight``.<br>
<br>
.. note::<br>
The synthetic feature weight is subject to L1 or L2<br>
regularization as all other features.<br>
To lessen the effect of regularization on synthetic feature weight<br>
(and therefore on the intercept) `intercept_scaling` has to be increased.</span></a></td>
<td class="value">1</td>
</tr>
<tr class="user-set even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=class_weight,-dict%20or%20%27balanced%27%2C%20default%3DNone" class="param-doc-link" rel="noreferrer" target="_blank">class_weight <span class="param-doc-description">class_weight: dict or 'balanced', default=None<br>
<br>
Weights associated with classes in the form ``{class_label: weight}``.<br>
If not given, all classes are supposed to have weight one.<br>
<br>
The "balanced" mode uses the values of y to automatically adjust<br>
weights inversely proportional to class frequencies in the input data<br>
as ``n_samples / (n_classes * np.bincount(y))``.<br>
<br>
Note that these weights will be multiplied with sample_weight (passed<br>
through the fit method) if sample_weight is specified.<br>
<br>
.. versionadded:: 0.17<br>
*class_weight='balanced'*</span></a></td>
<td class="value">'balanced'</td>
</tr>
<tr class="default odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=random_state,-int%2C%20RandomState%20instance%2C%20default%3DNone" class="param-doc-link" rel="noreferrer" target="_blank">random_state <span class="param-doc-description">random_state: int, RandomState instance, default=None<br>
<br>
Used when ``solver`` == 'sag', 'saga' or 'liblinear' to shuffle the<br>
data. See :term:`Glossary <random_state>` for details.</random_state></span></a></td>
<td class="value">None</td>
</tr>
<tr class="default even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=solver,-%7B%27lbfgs%27%2C%20%27liblinear%27%2C%20%27newton-cg%27%2C%20%27newton-cholesky%27%2C%20%27sag%27%2C%20%27saga%27%7D%2C%20%20%20%20%20%20%20%20%20%20%20%20%20default%3D%27lbfgs%27" class="param-doc-link" rel="noreferrer" target="_blank">solver <span class="param-doc-description">solver: {'lbfgs', 'liblinear', 'newton-cg', 'newton-cholesky', 'sag', 'saga'}, default='lbfgs'<br>
<br>
Algorithm to use in the optimization problem. Default is 'lbfgs'.<br>
To choose a solver, you might want to consider the following aspects:<br>
<br>
- 'lbfgs' is a good default solver because it works reasonably well for a wide<br>
class of problems.<br>
- For :term:`multiclass` problems (`n_classes &gt;= 3`), all solvers except<br>
'liblinear' minimize the full multinomial loss, 'liblinear' will raise an<br>
error.<br>
- 'newton-cholesky' is a good choice for<br>
`n_samples` &gt;&gt; `n_features * n_classes`, especially with one-hot encoded<br>
categorical features with rare categories. Be aware that the memory usage<br>
of this solver has a quadratic dependency on `n_features * n_classes`<br>
because it explicitly computes the full Hessian matrix.<br>
- For small datasets, 'liblinear' is a good choice, whereas 'sag'<br>
and 'saga' are faster for large ones;<br>
- 'liblinear' can only handle binary classification by default. To apply a<br>
one-versus-rest scheme for the multiclass setting one can wrap it with the<br>
:class:`~sklearn.multiclass.OneVsRestClassifier`.<br>
<br>
.. warning::<br>
The choice of the algorithm depends on the penalty chosen (`l1_ratio=0`<br>
for L2-penalty, `l1_ratio=1` for L1-penalty and `0 &lt; l1_ratio &lt; 1` for<br>
Elastic-Net) and on (multinomial) multiclass support:<br>
<br>
================= ======================== ======================<br>
solver l1_ratio multinomial multiclass<br>
================= ======================== ======================<br>
'lbfgs' l1_ratio=0 yes<br>
'liblinear' l1_ratio=1 or l1_ratio=0 no<br>
'newton-cg' l1_ratio=0 yes<br>
'newton-cholesky' l1_ratio=0 yes<br>
'sag' l1_ratio=0 yes<br>
'saga' 0&lt;=l1_ratio&lt;=1 yes<br>
================= ======================== ======================<br>
<br>
.. note::<br>
'sag' and 'saga' fast convergence is only guaranteed on features<br>
with approximately the same scale. You can preprocess the data with<br>
a scaler from :mod:`sklearn.preprocessing`.<br>
<br>
.. seealso::<br>
Refer to the :ref:`User Guide <logistic_regression>` for more<br>
information regarding :class:`LogisticRegression` and more specifically the<br>
:ref:`Table <logistic_regression_solvers>`<br>
summarizing solver/penalty supports.<br>
<br>
.. versionadded:: 0.17<br>
Stochastic Average Gradient (SAG) descent solver. Multinomial support in<br>
version 0.18.<br>
.. versionadded:: 0.19<br>
SAGA solver.<br>
.. versionchanged:: 0.22<br>
The default solver changed from 'liblinear' to 'lbfgs' in 0.22.<br>
.. versionadded:: 1.2<br>
newton-cholesky solver. Multinomial support in version 1.6.</logistic_regression_solvers></logistic_regression></span></a></td>
<td class="value">'lbfgs'</td>
</tr>
<tr class="default odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=max_iter,-int%2C%20default%3D100" class="param-doc-link" rel="noreferrer" target="_blank">max_iter <span class="param-doc-description">max_iter: int, default=100<br>
<br>
Maximum number of iterations taken for the solvers to converge.</span></a></td>
<td class="value">100</td>
</tr>
<tr class="default even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=verbose,-int%2C%20default%3D0" class="param-doc-link" rel="noreferrer" target="_blank">verbose <span class="param-doc-description">verbose: int, default=0<br>
<br>
For the liblinear and lbfgs solvers set verbose to any positive<br>
number for verbosity.</span></a></td>
<td class="value">0</td>
</tr>
<tr class="default odd">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=warm_start,-bool%2C%20default%3DFalse" class="param-doc-link" rel="noreferrer" target="_blank">warm_start <span class="param-doc-description">warm_start: bool, default=False<br>
<br>
When set to True, reuse the solution of the previous call to fit as<br>
initialization, otherwise, just erase the previous solution.<br>
Useless for liblinear solver. See :term:`the Glossary <warm_start>`.<br>
<br>
.. versionadded:: 0.17<br>
*warm_start* to support *lbfgs*, *newton-cg*, *sag*, *saga* solvers.</warm_start></span></a></td>
<td class="value">False</td>
</tr>
<tr class="default even">
<td><em></em></td>
<td class="param"><a href="https://scikit-learn.org/1.8/modules/generated/sklearn.linear_model.LogisticRegression.html#:~:text=n_jobs,-int%2C%20default%3DNone" class="param-doc-link" rel="noreferrer" target="_blank">n_jobs <span class="param-doc-description">n_jobs: int, default=None<br>
<br>
Does not have any effect.<br>
<br>
.. deprecated:: 1.8<br>
`n_jobs` is deprecated in version 1.8 and will be removed in 1.10.</span></a></td>
<td class="value">None</td>
</tr>
</tbody>
</table>

            </details>
        </div>
    </div></div></div></div></div><script>function copyToClipboard(text, element) {
    // Get the parameter prefix from the closest toggleable content
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;

    const originalStyle = element.style;
    const computedStyle = window.getComputedStyle(element);
    const originalWidth = computedStyle.width;
    const originalHTML = element.innerHTML.replace('Copied!', '');

    navigator.clipboard.writeText(fullParamName)
        .then(() => {
            element.style.width = originalWidth;
            element.style.color = 'green';
            element.innerHTML = "Copied!";

            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            element.style.color = 'red';
            element.innerHTML = "Failed!";
            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        });
    return false;
}

document.querySelectorAll('.copy-paste-icon').forEach(function(element) {
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const paramName = element.parentElement.nextElementSibling
        .textContent.trim().split(' ')[0];
    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;

    element.setAttribute('title', fullParamName);
});


/**
 * Adapted from Skrub
 * https://github.com/skrub-data/skrub/blob/403466d1d5d4dc76a7ef569b3f8228db59a31dc3/skrub/_reporting/_data/templates/report.js#L789
 * @returns "light" or "dark"
 */
function detectTheme(element) {
    const body = document.querySelector('body');

    // Check VSCode theme
    const themeKindAttr = body.getAttribute('data-vscode-theme-kind');
    const themeNameAttr = body.getAttribute('data-vscode-theme-name');

    if (themeKindAttr && themeNameAttr) {
        const themeKind = themeKindAttr.toLowerCase();
        const themeName = themeNameAttr.toLowerCase();

        if (themeKind.includes("dark") || themeName.includes("dark")) {
            return "dark";
        }
        if (themeKind.includes("light") || themeName.includes("light")) {
            return "light";
        }
    }

    // Check Jupyter theme
    if (body.getAttribute('data-jp-theme-light') === 'false') {
        return 'dark';
    } else if (body.getAttribute('data-jp-theme-light') === 'true') {
        return 'light';
    }

    // Guess based on a parent element's color
    const color = window.getComputedStyle(element.parentNode, null).getPropertyValue('color');
    const match = color.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*$/i);
    if (match) {
        const [r, g, b] = [
            parseFloat(match[1]),
            parseFloat(match[2]),
            parseFloat(match[3])
        ];

        // https://en.wikipedia.org/wiki/HSL_and_HSV#Lightness
        const luma = 0.299 * r + 0.587 * g + 0.114 * b;

        if (luma > 180) {
            // If the text is very bright we have a dark theme
            return 'dark';
        }
        if (luma < 75) {
            // If the text is very dark we have a light theme
            return 'light';
        }
        // Otherwise fall back to the next heuristic.
    }

    // Fallback to system preference
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}


function forceTheme(elementId) {
    const estimatorElement = document.querySelector(`#${elementId}`);
    if (estimatorElement === null) {
        console.error(`Element with id ${elementId} not found.`);
    } else {
        const theme = detectTheme(estimatorElement);
        estimatorElement.classList.add(theme);
    }
}

forceTheme('sk-container-id-1');</script>
</div>
</div>
<div id="fd02ece9" class="cell" data-execution_count="95">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>features_names <span class="op">=</span> features_names.toPandas()[<span class="st">'feature_name'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:51 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:51 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 118:==================================================&gt;     (9 + 1) / 10]26/02/16 10:03:53 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:53 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:53 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:53 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 123:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
</div>
<div id="80504834" class="cell" data-execution_count="96">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>features_names[<span class="bu">range</span>(<span class="dv">6</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>0    n_actions_per_category_id#C#1002.0
1    n_actions_per_category_id#C#1204.0
2    n_actions_per_category_id#O#1002.0
3    n_actions_per_category_id#O#1204.0
4            n_days_since_last_action#C
5            n_days_since_last_action#O
Name: feature_name, dtype: str</code></pre>
</div>
</div>
<div id="8c826c4b" class="cell" data-execution_count="97">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="ed1beefb" class="cell" data-execution_count="98">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">5</span>))</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>plt.stem(clf.coef_[<span class="dv">0</span>]) <span class="co"># , use_line_collection=True)</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Logistic regression coefficients'</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>Text(0.5, 1.0, 'Logistic regression coefficients')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook08_webdata-III_files/figure-html/cell-99-output-2.png" width="1251" height="438" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c3a2861a" class="cell" data-execution_count="99">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>clf.coef_[<span class="dv">0</span>].shape[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>90</code></pre>
</div>
</div>
<div id="cc8b9b6a" class="cell" data-execution_count="100">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(features_names)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>92</code></pre>
</div>
</div>
<div id="52b944d2" class="cell" data-execution_count="101">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We change the fontsize of minor ticks label</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> plt.xticks(np.arange(clf.coef_[<span class="dv">0</span>].shape[<span class="dv">0</span>]), features_names, </span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>           rotation<span class="op">=</span><span class="st">'vertical'</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[94]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># We change the fontsize of minor ticks label</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> _ = <span class="ansi-yellow-bg">plt</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">xticks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">np</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">arange</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">clf</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">coef_</span><span class="ansi-yellow-bg">[</span><span class="ansi-green-fg ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">shape</span><span class="ansi-yellow-bg">[</span><span class="ansi-green-fg ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">features_names</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span>
<span class="ansi-green-fg">      3</span> <span class="ansi-yellow-bg">           </span><span class="ansi-yellow-bg">rotation</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-fg ansi-yellow-bg">vertical</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">fontsize</span><span class="ansi-yellow-bg">=</span><span class="ansi-green-fg ansi-yellow-bg">8</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Documents/IFEBY310/.nlp-venv/lib/python3.12/site-packages/matplotlib/pyplot.py:2246</span>, in <span class="ansi-cyan-fg">xticks</span><span class="ansi-blue-fg">(ticks, labels, minor, **kwargs)</span>
<span class="ansi-green-fg">   2244</span>         l._internal_update(kwargs)
<span class="ansi-green-fg">   2245</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">2246</span>     labels_out = <span class="ansi-yellow-bg">ax</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">set_xticklabels</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">labels</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">minor</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">minor</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   2248</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> locs, labels_out

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Documents/IFEBY310/.nlp-venv/lib/python3.12/site-packages/matplotlib/axes/_base.py:74</span>, in <span class="ansi-cyan-fg">_axis_method_wrapper.__set_name__.&lt;locals&gt;.wrapper</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">     73</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">wrapper</span>(<span style="color:rgb(0,135,0)">self</span>, *args, **kwargs):
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">74</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">get_method</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Documents/IFEBY310/.nlp-venv/lib/python3.12/site-packages/matplotlib/axis.py:2106</span>, in <span class="ansi-cyan-fg">Axis.set_ticklabels</span><span class="ansi-blue-fg">(self, labels, minor, fontdict, **kwargs)</span>
<span class="ansi-green-fg">   2102</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(locator, mticker.FixedLocator):
<span class="ansi-green-fg">   2103</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Passing [] as a list of labels is often used as a way to</span>
<span class="ansi-green-fg">   2104</span>     <span style="font-style:italic;color:rgb(95,135,135)"># remove all tick labels, so only error for &gt; 0 labels</span>
<span class="ansi-green-fg">   2105</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">len</span>(locator.locs) != <span style="color:rgb(0,135,0)">len</span>(labels) <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">len</span>(labels) != <span class="ansi-green-fg">0</span>:
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">2106</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg">   2107</span>             <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">The number of FixedLocator locations</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   2108</span>             <span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg"> (</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">len</span>(locator.locs)<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">), usually from a call to</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   2109</span>             <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg"> set_ticks, does not match</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   2110</span>             <span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg"> the number of labels (</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">len</span>(labels)<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">).</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">   2111</span>     tickd = {loc: lab <span style="font-weight:bold;color:rgb(0,135,0)">for</span> loc, lab <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(locator.locs, labels)}
<span class="ansi-green-fg">   2112</span>     func = functools.partial(<span style="color:rgb(0,135,0)">self</span>._format_with_dict, tickd)

<span class="ansi-red-fg">ValueError</span>: The number of FixedLocator locations (90), usually from a call to set_ticks, does not match the number of labels (92).</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook08_webdata-III_files/figure-html/cell-102-output-2.png" width="579" height="416" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="06562263" class="cell" data-execution_count="102">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> plt.yticks(fontsize<span class="op">=</span><span class="dv">14</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook08_webdata-III_files/figure-html/cell-103-output-1.png" width="590" height="418" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a5e10fb0" class="cell" data-execution_count="103">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> precision_recall_curve, f1_score</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>precision, recall, _ <span class="op">=</span> precision_recall_curve(y_test, clf.predict_proba(X_test)[:, <span class="dv">1</span>])</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>plt.plot(recall, precision, label<span class="op">=</span><span class="st">'LR (F1=</span><span class="sc">%.2f</span><span class="st">)'</span> <span class="op">%</span> f1_score(y_test, clf.predict(X_test)), lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>plt.xlim([<span class="fl">0.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="fl">0.0</span>, <span class="fl">1.05</span>])</span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Recall'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Precision'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Precision/recall curve'</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"upper right"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook08_webdata-III_files/figure-html/cell-104-output-1.png" width="682" height="538" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analyse-the-tables" class="level1">
<h1>Analyse the tables</h1>
<div id="ef45ff2f" class="cell" data-execution_count="104">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="st">    ANALYZE TABLE db_table </span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="st">    COMPUTE STATISTICS</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a><span class="st">    FOR COLUMNS xid</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="4b2550e7" class="cell" data-execution_count="105">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>df.createOrReplaceTempView(<span class="st">"db_table"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="108fd467" class="cell" data-execution_count="106">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>df.columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>['feature_name',
 'xid',
 'value',
 'col',
 'row',
 'keep',
 'sum_keep',
 'row_new',
 'col_new']</code></pre>
</div>
</div>
<div id="c525d761" class="cell" data-execution_count="107">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"cache table db_table"</span>).show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>26/02/16 10:03:55 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:55 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:55 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:55 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:55 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 124:==================================================&gt;     (9 + 1) / 10]26/02/16 10:03:57 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:57 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:57 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:57 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:58 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:58 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:58 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
26/02/16 10:03:58 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.
[Stage 129:&gt;                                                        (0 + 1) / 1]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>++
||
++
++
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div id="ce3ddabd" class="cell" data-execution_count="108">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>spark.sql(query).show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>++
||
++
++
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 135:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
</div>
<div id="db0a8924" class="cell" data-execution_count="109">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"show tables"</span>).show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+---------+---------+-----------+
|namespace|tableName|isTemporary|
+---------+---------+-----------+
|         | db_table|       true|
|         |  webdata|       true|
+---------+---------+-----------+
</code></pre>
</div>
</div>
<div id="b9750788" class="cell" data-execution_count="110">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>spark.stop()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/s-v-b\.github\.io\/IFEBY310\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Stéphane Boucheron</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/s-v-b/IFEBY310/edit/main/core/notebooks/notebook08_webdata-III.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/s-v-b/IFEBY310/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with blood, sweat, tears, and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>